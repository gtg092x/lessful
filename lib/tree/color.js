"use strict";

var Node = require("./node"),
    colors = require("../data/colors");

//
// RGB Colors - #ff0014, #eee
//
var Color = function Color(rgb, a, originalForm) {
    //
    // The end goal here, is to parse the arguments
    // into an integer triplet, such as `128, 255, 0`
    //
    // This facilitates operations and conversions.
    //
    if (Array.isArray(rgb)) {
        this.rgb = rgb;
    } else if (rgb.length == 6) {
        this.rgb = rgb.match(/.{2}/g).map(function (c) {
            return parseInt(c, 16);
        });
    } else {
        this.rgb = rgb.split('').map(function (c) {
            return parseInt(c + c, 16);
        });
    }
    this.alpha = typeof a === 'number' ? a : 1;
    if (typeof originalForm !== 'undefined') {
        this.value = originalForm;
    }
};

Color.prototype = new Node();
Color.prototype.type = "Color";

function clamp(v, max) {
    return Math.min(Math.max(v, 0), max);
}

function toHex(v) {
    return '#' + v.map(function (c) {
        c = clamp(Math.round(c), 255);
        return (c < 16 ? '0' : '') + c.toString(16);
    }).join('');
}

Color.prototype.luma = function () {
    var r = this.rgb[0] / 255,
        g = this.rgb[1] / 255,
        b = this.rgb[2] / 255;

    r = r <= 0.03928 ? r / 12.92 : Math.pow((r + 0.055) / 1.055, 2.4);
    g = g <= 0.03928 ? g / 12.92 : Math.pow((g + 0.055) / 1.055, 2.4);
    b = b <= 0.03928 ? b / 12.92 : Math.pow((b + 0.055) / 1.055, 2.4);

    return 0.2126 * r + 0.7152 * g + 0.0722 * b;
};
Color.prototype.genCSS = function (context, output) {
    output.add(this.toCSS(context));
};
Color.prototype.toCSS = function (context, doNotCompress) {
    var compress = context && context.compress && !doNotCompress,
        color,
        alpha;

    // `value` is set if this color was originally
    // converted from a named color string so we need
    // to respect this and try to output named color too.
    if (this.value) {
        return this.value;
    }

    // If we have some transparency, the only way to represent it
    // is via `rgba`. Otherwise, we use the hex representation,
    // which has better compatibility with older browsers.
    // Values are capped between `0` and `255`, rounded and zero-padded.
    alpha = this.fround(context, this.alpha);
    if (alpha < 1) {
        return "rgba(" + this.rgb.map(function (c) {
            return clamp(Math.round(c), 255);
        }).concat(clamp(alpha, 1)).join(',' + (compress ? '' : ' ')) + ")";
    }

    color = this.toRGB();

    if (compress) {
        var splitcolor = color.split('');

        // Convert color to short format
        if (splitcolor[1] === splitcolor[2] && splitcolor[3] === splitcolor[4] && splitcolor[5] === splitcolor[6]) {
            color = '#' + splitcolor[1] + splitcolor[3] + splitcolor[5];
        }
    }

    return color;
};

//
// Operations have to be done per-channel, if not,
// channels will spill onto each other. Once we have
// our result, in the form of an integer triplet,
// we create a new Color node to hold the result.
//
Color.prototype.operate = function (context, op, other) {
    var rgb = new Array(3);
    var alpha = this.alpha * (1 - other.alpha) + other.alpha;
    for (var c = 0; c < 3; c++) {
        rgb[c] = this._operate(context, op, this.rgb[c], other.rgb[c]);
    }
    return new Color(rgb, alpha);
};
Color.prototype.toRGB = function () {
    return toHex(this.rgb);
};
Color.prototype.toHSL = function () {
    var r = this.rgb[0] / 255,
        g = this.rgb[1] / 255,
        b = this.rgb[2] / 255,
        a = this.alpha;

    var max = Math.max(r, g, b),
        min = Math.min(r, g, b);
    var h,
        s,
        l = (max + min) / 2,
        d = max - min;

    if (max === min) {
        h = s = 0;
    } else {
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

        switch (max) {
            case r:
                h = (g - b) / d + (g < b ? 6 : 0);break;
            case g:
                h = (b - r) / d + 2;break;
            case b:
                h = (r - g) / d + 4;break;
        }
        h /= 6;
    }
    return { h: h * 360, s: s, l: l, a: a };
};
//Adapted from http://mjijackson.com/2008/02/rgb-to-hsl-and-rgb-to-hsv-color-model-conversion-algorithms-in-javascript
Color.prototype.toHSV = function () {
    var r = this.rgb[0] / 255,
        g = this.rgb[1] / 255,
        b = this.rgb[2] / 255,
        a = this.alpha;

    var max = Math.max(r, g, b),
        min = Math.min(r, g, b);
    var h,
        s,
        v = max;

    var d = max - min;
    if (max === 0) {
        s = 0;
    } else {
        s = d / max;
    }

    if (max === min) {
        h = 0;
    } else {
        switch (max) {
            case r:
                h = (g - b) / d + (g < b ? 6 : 0);break;
            case g:
                h = (b - r) / d + 2;break;
            case b:
                h = (r - g) / d + 4;break;
        }
        h /= 6;
    }
    return { h: h * 360, s: s, v: v, a: a };
};
Color.prototype.toARGB = function () {
    return toHex([this.alpha * 255].concat(this.rgb));
};
Color.prototype.compare = function (x) {
    return x.rgb && x.rgb[0] === this.rgb[0] && x.rgb[1] === this.rgb[1] && x.rgb[2] === this.rgb[2] && x.alpha === this.alpha ? 0 : undefined;
};

Color.fromKeyword = function (keyword) {
    var c,
        key = keyword.toLowerCase();
    if (colors.hasOwnProperty(key)) {
        c = new Color(colors[key].slice(1));
    } else if (key === "transparent") {
        c = new Color([0, 0, 0], 0);
    }

    if (c) {
        c.value = keyword;
        return c;
    }
};
module.exports = Color;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90cmVlL2NvbG9yLmpzIl0sIm5hbWVzIjpbIk5vZGUiLCJyZXF1aXJlIiwiY29sb3JzIiwiQ29sb3IiLCJyZ2IiLCJhIiwib3JpZ2luYWxGb3JtIiwiQXJyYXkiLCJpc0FycmF5IiwibGVuZ3RoIiwibWF0Y2giLCJtYXAiLCJjIiwicGFyc2VJbnQiLCJzcGxpdCIsImFscGhhIiwidmFsdWUiLCJwcm90b3R5cGUiLCJ0eXBlIiwiY2xhbXAiLCJ2IiwibWF4IiwiTWF0aCIsIm1pbiIsInRvSGV4Iiwicm91bmQiLCJ0b1N0cmluZyIsImpvaW4iLCJsdW1hIiwiciIsImciLCJiIiwicG93IiwiZ2VuQ1NTIiwiY29udGV4dCIsIm91dHB1dCIsImFkZCIsInRvQ1NTIiwiZG9Ob3RDb21wcmVzcyIsImNvbXByZXNzIiwiY29sb3IiLCJmcm91bmQiLCJjb25jYXQiLCJ0b1JHQiIsInNwbGl0Y29sb3IiLCJvcGVyYXRlIiwib3AiLCJvdGhlciIsIl9vcGVyYXRlIiwidG9IU0wiLCJoIiwicyIsImwiLCJkIiwidG9IU1YiLCJ0b0FSR0IiLCJjb21wYXJlIiwieCIsInVuZGVmaW5lZCIsImZyb21LZXl3b3JkIiwia2V5d29yZCIsImtleSIsInRvTG93ZXJDYXNlIiwiaGFzT3duUHJvcGVydHkiLCJzbGljZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSUEsT0FBT0MsUUFBUSxRQUFSLENBQVg7QUFBQSxJQUNJQyxTQUFTRCxRQUFRLGdCQUFSLENBRGI7O0FBR0E7QUFDQTtBQUNBO0FBQ0EsSUFBSUUsUUFBUSxTQUFSQSxLQUFRLENBQVVDLEdBQVYsRUFBZUMsQ0FBZixFQUFrQkMsWUFBbEIsRUFBZ0M7QUFDeEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsUUFBSUMsTUFBTUMsT0FBTixDQUFjSixHQUFkLENBQUosRUFBd0I7QUFDcEIsYUFBS0EsR0FBTCxHQUFXQSxHQUFYO0FBQ0gsS0FGRCxNQUVPLElBQUlB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QyxPQUFoQixHQUEwQixVQUFVQyxDQUFWLEVBQWE7QUFDbkMsV0FBUUEsRUFBRXJELEdBQUYsSUFDSnFELEVBQUVyRCxHQUFGLENBQU0sQ0FBTixNQUFhLEtBQUtBLEdBQUwsQ0FBUyxDQUFULENBRFQsSUFFSnFELEVBQUVyRCxHQUFGLENBQU0sQ0FBTixNQUFhLEtBQUtBLEdBQUwsQ0FBUyxDQUFULENBRlQsSUFHSnFELEVBQUVyRCxHQUFGLENBQU0sQ0FBTixNQUFhLEtBQUtBLEdBQUwsQ0FBUyxDQUFULENBSFQsSUFJSnFELEVBQUUxQyxLQUFGLEtBQWEsS0FBS0EsS0FKZixHQUl3QixDQUp4QixHQUk0QjJDLFNBSm5DO0FBS0gsQ0FORDs7QUFRQXZELE1BQU13RCxXQUFOLEdBQW9CLFVBQVNDLE9BQVQsRUFBa0I7QUFDbEMsUUFBSWhELENBQUo7QUFBQSxRQUFPaUQsTUFBTUQsUUFBUUUsV0FBUixFQUFiO0FBQ0EsUUFBSTVELE9BQU82RCxjQUFQLENBQXNCRixHQUF0QixDQUFKLEVBQWdDO0FBQzVCakQsWUFBSSxJQUFJVCxLQUFKLENBQVVELE9BQU8yRCxHQUFQLEVBQVlHLEtBQVosQ0FBa0IsQ0FBbEIsQ0FBVixDQUFKO0FBQ0gsS0FGRCxNQUdLLElBQUlILFFBQVEsYUFBWixFQUEyQjtBQUM1QmpELFlBQUksSUFBSVQsS0FBSixDQUFVLENBQUMsQ0FBRCxFQUFJLENBQUosRUFBTyxDQUFQLENBQVYsRUFBcUIsQ0FBckIsQ0FBSjtBQUNIOztBQUVELFFBQUlTLENBQUosRUFBTztBQUNIQSxVQUFFSSxLQUFGLEdBQVU0QyxPQUFWO0FBQ0EsZUFBT2hELENBQVA7QUFDSDtBQUNKLENBYkQ7QUFjQXFELE9BQU9DLE9BQVAsR0FBaUIvRCxLQUFqQiIsImZpbGUiOiJjb2xvci5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBOb2RlID0gcmVxdWlyZShcIi4vbm9kZVwiKSxcbiAgICBjb2xvcnMgPSByZXF1aXJlKFwiLi4vZGF0YS9jb2xvcnNcIik7XG5cbi8vXG4vLyBSR0IgQ29sb3JzIC0gI2ZmMDAxNCwgI2VlZVxuLy9cbnZhciBDb2xvciA9IGZ1bmN0aW9uIChyZ2IsIGEsIG9yaWdpbmFsRm9ybSkge1xuICAgIC8vXG4gICAgLy8gVGhlIGVuZCBnb2FsIGhlcmUsIGlzIHRvIHBhcnNlIHRoZSBhcmd1bWVudHNcbiAgICAvLyBpbnRvIGFuIGludGVnZXIgdHJpcGxldCwgc3VjaCBhcyBgMTI4LCAyNTUsIDBgXG4gICAgLy9cbiAgICAvLyBUaGlzIGZhY2lsaXRhdGVzIG9wZXJhdGlvbnMgYW5kIGNvbnZlcnNpb25zLlxuICAgIC8vXG4gICAgaWYgKEFycmF5LmlzQXJyYXkocmdiKSkge1xuICAgICAgICB0aGlzLnJnYiA9IHJnYjtcbiAgICB9IGVsc2UgaWYgKHJnYi5sZW5ndGggPT0gNikge1xuICAgICAgICB0aGlzLnJnYiA9IHJnYi5tYXRjaCgvLnsyfS9nKS5tYXAoZnVuY3Rpb24gKGMpIHtcbiAgICAgICAgICAgIHJldHVybiBwYXJzZUludChjLCAxNik7XG4gICAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMucmdiID0gcmdiLnNwbGl0KCcnKS5tYXAoZnVuY3Rpb24gKGMpIHtcbiAgICAgICAgICAgIHJldHVybiBwYXJzZUludChjICsgYywgMTYpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgdGhpcy5hbHBoYSA9IHR5cGVvZiBhID09PSAnbnVtYmVyJyA/IGEgOiAxO1xuICAgIGlmICh0eXBlb2Ygb3JpZ2luYWxGb3JtICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICB0aGlzLnZhbHVlID0gb3JpZ2luYWxGb3JtO1xuICAgIH1cbn07XG5cbkNvbG9yLnByb3RvdHlwZSA9IG5ldyBOb2RlKCk7XG5Db2xvci5wcm90b3R5cGUudHlwZSA9IFwiQ29sb3JcIjtcblxuZnVuY3Rpb24gY2xhbXAodiwgbWF4KSB7XG4gICAgcmV0dXJuIE1hdGgubWluKE1hdGgubWF4KHYsIDApLCBtYXgpO1xufVxuXG5mdW5jdGlvbiB0b0hleCh2KSB7XG4gICAgcmV0dXJuICcjJyArIHYubWFwKGZ1bmN0aW9uIChjKSB7XG4gICAgICAgIGMgPSBjbGFtcChNYXRoLnJvdW5kKGMpLCAyNTUpO1xuICAgICAgICByZXR1cm4gKGMgPCAxNiA/ICcwJyA6ICcnKSArIGMudG9TdHJpbmcoMTYpO1xuICAgIH0pLmpvaW4oJycpO1xufVxuXG5Db2xvci5wcm90b3R5cGUubHVtYSA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgciA9IHRoaXMucmdiWzBdIC8gMjU1LFxuICAgICAgICBnID0gdGhpcy5yZ2JbMV0gLyAyNTUsXG4gICAgICAgIGIgPSB0aGlzLnJnYlsyXSAvIDI1NTtcblxuICAgIHIgPSAociA8PSAwLjAzOTI4KSA/IHIgLyAxMi45MiA6IE1hdGgucG93KCgociArIDAuMDU1KSAvIDEuMDU1KSwgMi40KTtcbiAgICBnID0gKGcgPD0gMC4wMzkyOCkgPyBnIC8gMTIuOTIgOiBNYXRoLnBvdygoKGcgKyAwLjA1NSkgLyAxLjA1NSksIDIuNCk7XG4gICAgYiA9IChiIDw9IDAuMDM5MjgpID8gYiAvIDEyLjkyIDogTWF0aC5wb3coKChiICsgMC4wNTUpIC8gMS4wNTUpLCAyLjQpO1xuXG4gICAgcmV0dXJuIDAuMjEyNiAqIHIgKyAwLjcxNTIgKiBnICsgMC4wNzIyICogYjtcbn07XG5Db2xvci5wcm90b3R5cGUuZ2VuQ1NTID0gZnVuY3Rpb24gKGNvbnRleHQsIG91dHB1dCkge1xuICAgIG91dHB1dC5hZGQodGhpcy50b0NTUyhjb250ZXh0KSk7XG59O1xuQ29sb3IucHJvdG90eXBlLnRvQ1NTID0gZnVuY3Rpb24gKGNvbnRleHQsIGRvTm90Q29tcHJlc3MpIHtcbiAgICB2YXIgY29tcHJlc3MgPSBjb250ZXh0ICYmIGNvbnRleHQuY29tcHJlc3MgJiYgIWRvTm90Q29tcHJlc3MsIGNvbG9yLCBhbHBoYTtcblxuICAgIC8vIGB2YWx1ZWAgaXMgc2V0IGlmIHRoaXMgY29sb3Igd2FzIG9yaWdpbmFsbHlcbiAgICAvLyBjb252ZXJ0ZWQgZnJvbSBhIG5hbWVkIGNvbG9yIHN0cmluZyBzbyB3ZSBuZWVkXG4gICAgLy8gdG8gcmVzcGVjdCB0aGlzIGFuZCB0cnkgdG8gb3V0cHV0IG5hbWVkIGNvbG9yIHRvby5cbiAgICBpZiAodGhpcy52YWx1ZSkge1xuICAgICAgICByZXR1cm4gdGhpcy52YWx1ZTtcbiAgICB9XG5cbiAgICAvLyBJZiB3ZSBoYXZlIHNvbWUgdHJhbnNwYXJlbmN5LCB0aGUgb25seSB3YXkgdG8gcmVwcmVzZW50IGl0XG4gICAgLy8gaXMgdmlhIGByZ2JhYC4gT3RoZXJ3aXNlLCB3ZSB1c2UgdGhlIGhleCByZXByZXNlbnRhdGlvbixcbiAgICAvLyB3aGljaCBoYXMgYmV0dGVyIGNvbXBhdGliaWxpdHkgd2l0aCBvbGRlciBicm93c2Vycy5cbiAgICAvLyBWYWx1ZXMgYXJlIGNhcHBlZCBiZXR3ZWVuIGAwYCBhbmQgYDI1NWAsIHJvdW5kZWQgYW5kIHplcm8tcGFkZGVkLlxuICAgIGFscGhhID0gdGhpcy5mcm91bmQoY29udGV4dCwgdGhpcy5hbHBoYSk7XG4gICAgaWYgKGFscGhhIDwgMSkge1xuICAgICAgICByZXR1cm4gXCJyZ2JhKFwiICsgdGhpcy5yZ2IubWFwKGZ1bmN0aW9uIChjKSB7XG4gICAgICAgICAgICByZXR1cm4gY2xhbXAoTWF0aC5yb3VuZChjKSwgMjU1KTtcbiAgICAgICAgfSkuY29uY2F0KGNsYW1wKGFscGhhLCAxKSlcbiAgICAgICAgICAgIC5qb2luKCcsJyArIChjb21wcmVzcyA/ICcnIDogJyAnKSkgKyBcIilcIjtcbiAgICB9XG5cbiAgICBjb2xvciA9IHRoaXMudG9SR0IoKTtcblxuICAgIGlmIChjb21wcmVzcykge1xuICAgICAgICB2YXIgc3BsaXRjb2xvciA9IGNvbG9yLnNwbGl0KCcnKTtcblxuICAgICAgICAvLyBDb252ZXJ0IGNvbG9yIHRvIHNob3J0IGZvcm1hdFxuICAgICAgICBpZiAoc3BsaXRjb2xvclsxXSA9PT0gc3BsaXRjb2xvclsyXSAmJiBzcGxpdGNvbG9yWzNdID09PSBzcGxpdGNvbG9yWzRdICYmIHNwbGl0Y29sb3JbNV0gPT09IHNwbGl0Y29sb3JbNl0pIHtcbiAgICAgICAgICAgIGNvbG9yID0gJyMnICsgc3BsaXRjb2xvclsxXSArIHNwbGl0Y29sb3JbM10gKyBzcGxpdGNvbG9yWzVdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbG9yO1xufTtcblxuLy9cbi8vIE9wZXJhdGlvbnMgaGF2ZSB0byBiZSBkb25lIHBlci1jaGFubmVsLCBpZiBub3QsXG4vLyBjaGFubmVscyB3aWxsIHNwaWxsIG9udG8gZWFjaCBvdGhlci4gT25jZSB3ZSBoYXZlXG4vLyBvdXIgcmVzdWx0LCBpbiB0aGUgZm9ybSBvZiBhbiBpbnRlZ2VyIHRyaXBsZXQsXG4vLyB3ZSBjcmVhdGUgYSBuZXcgQ29sb3Igbm9kZSB0byBob2xkIHRoZSByZXN1bHQuXG4vL1xuQ29sb3IucHJvdG90eXBlLm9wZXJhdGUgPSBmdW5jdGlvbiAoY29udGV4dCwgb3AsIG90aGVyKSB7XG4gICAgdmFyIHJnYiA9IG5ldyBBcnJheSgzKTtcbiAgICB2YXIgYWxwaGEgPSB0aGlzLmFscGhhICogKDEgLSBvdGhlci5hbHBoYSkgKyBvdGhlci5hbHBoYTtcbiAgICBmb3IgKHZhciBjID0gMDsgYyA8IDM7IGMrKykge1xuICAgICAgICByZ2JbY10gPSB0aGlzLl9vcGVyYXRlKGNvbnRleHQsIG9wLCB0aGlzLnJnYltjXSwgb3RoZXIucmdiW2NdKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBDb2xvcihyZ2IsIGFscGhhKTtcbn07XG5Db2xvci5wcm90b3R5cGUudG9SR0IgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRvSGV4KHRoaXMucmdiKTtcbn07XG5Db2xvci5wcm90b3R5cGUudG9IU0wgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHIgPSB0aGlzLnJnYlswXSAvIDI1NSxcbiAgICAgICAgZyA9IHRoaXMucmdiWzFdIC8gMjU1LFxuICAgICAgICBiID0gdGhpcy5yZ2JbMl0gLyAyNTUsXG4gICAgICAgIGEgPSB0aGlzLmFscGhhO1xuXG4gICAgdmFyIG1heCA9IE1hdGgubWF4KHIsIGcsIGIpLCBtaW4gPSBNYXRoLm1pbihyLCBnLCBiKTtcbiAgICB2YXIgaCwgcywgbCA9IChtYXggKyBtaW4pIC8gMiwgZCA9IG1heCAtIG1pbjtcblxuICAgIGlmIChtYXggPT09IG1pbikge1xuICAgICAgICBoID0gcyA9IDA7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcyA9IGwgPiAwLjUgPyBkIC8gKDIgLSBtYXggLSBtaW4pIDogZCAvIChtYXggKyBtaW4pO1xuXG4gICAgICAgIHN3aXRjaCAobWF4KSB7XG4gICAgICAgICAgICBjYXNlIHI6IGggPSAoZyAtIGIpIC8gZCArIChnIDwgYiA/IDYgOiAwKTsgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIGc6IGggPSAoYiAtIHIpIC8gZCArIDI7ICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIGI6IGggPSAociAtIGcpIC8gZCArIDQ7ICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgaCAvPSA2O1xuICAgIH1cbiAgICByZXR1cm4geyBoOiBoICogMzYwLCBzOiBzLCBsOiBsLCBhOiBhIH07XG59O1xuLy9BZGFwdGVkIGZyb20gaHR0cDovL21qaWphY2tzb24uY29tLzIwMDgvMDIvcmdiLXRvLWhzbC1hbmQtcmdiLXRvLWhzdi1jb2xvci1tb2RlbC1jb252ZXJzaW9uLWFsZ29yaXRobXMtaW4tamF2YXNjcmlwdFxuQ29sb3IucHJvdG90eXBlLnRvSFNWID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciByID0gdGhpcy5yZ2JbMF0gLyAyNTUsXG4gICAgICAgIGcgPSB0aGlzLnJnYlsxXSAvIDI1NSxcbiAgICAgICAgYiA9IHRoaXMucmdiWzJdIC8gMjU1LFxuICAgICAgICBhID0gdGhpcy5hbHBoYTtcblxuICAgIHZhciBtYXggPSBNYXRoLm1heChyLCBnLCBiKSwgbWluID0gTWF0aC5taW4ociwgZywgYik7XG4gICAgdmFyIGgsIHMsIHYgPSBtYXg7XG5cbiAgICB2YXIgZCA9IG1heCAtIG1pbjtcbiAgICBpZiAobWF4ID09PSAwKSB7XG4gICAgICAgIHMgPSAwO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHMgPSBkIC8gbWF4O1xuICAgIH1cblxuICAgIGlmIChtYXggPT09IG1pbikge1xuICAgICAgICBoID0gMDtcbiAgICB9IGVsc2Uge1xuICAgICAgICBzd2l0Y2gobWF4KSB7XG4gICAgICAgICAgICBjYXNlIHI6IGggPSAoZyAtIGIpIC8gZCArIChnIDwgYiA/IDYgOiAwKTsgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIGc6IGggPSAoYiAtIHIpIC8gZCArIDI7IGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBiOiBoID0gKHIgLSBnKSAvIGQgKyA0OyBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBoIC89IDY7XG4gICAgfVxuICAgIHJldHVybiB7IGg6IGggKiAzNjAsIHM6IHMsIHY6IHYsIGE6IGEgfTtcbn07XG5Db2xvci5wcm90b3R5cGUudG9BUkdCID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0b0hleChbdGhpcy5hbHBoYSAqIDI1NV0uY29uY2F0KHRoaXMucmdiKSk7XG59O1xuQ29sb3IucHJvdG90eXBlLmNvbXBhcmUgPSBmdW5jdGlvbiAoeCkge1xuICAgIHJldHVybiAoeC5yZ2IgJiZcbiAgICAgICAgeC5yZ2JbMF0gPT09IHRoaXMucmdiWzBdICYmXG4gICAgICAgIHgucmdiWzFdID09PSB0aGlzLnJnYlsxXSAmJlxuICAgICAgICB4LnJnYlsyXSA9PT0gdGhpcy5yZ2JbMl0gJiZcbiAgICAgICAgeC5hbHBoYSAgPT09IHRoaXMuYWxwaGEpID8gMCA6IHVuZGVmaW5lZDtcbn07XG5cbkNvbG9yLmZyb21LZXl3b3JkID0gZnVuY3Rpb24oa2V5d29yZCkge1xuICAgIHZhciBjLCBrZXkgPSBrZXl3b3JkLnRvTG93ZXJDYXNlKCk7XG4gICAgaWYgKGNvbG9ycy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgIGMgPSBuZXcgQ29sb3IoY29sb3JzW2tleV0uc2xpY2UoMSkpO1xuICAgIH1cbiAgICBlbHNlIGlmIChrZXkgPT09IFwidHJhbnNwYXJlbnRcIikge1xuICAgICAgICBjID0gbmV3IENvbG9yKFswLCAwLCAwXSwgMCk7XG4gICAgfVxuXG4gICAgaWYgKGMpIHtcbiAgICAgICAgYy52YWx1ZSA9IGtleXdvcmQ7XG4gICAgICAgIHJldHVybiBjO1xuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENvbG9yO1xuIl19