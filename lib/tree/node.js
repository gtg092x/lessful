"use strict";

var Node = function Node() {
    this.parent = null;
    this.visibilityBlocks = undefined;
    this.nodeVisible = undefined;
    this.rootNode = null;
    this.parsed = null;

    var self = this;
    Object.defineProperty(this, "currentFileInfo", {
        get: function get() {
            return self.fileInfo();
        }
    });
    Object.defineProperty(this, "index", {
        get: function get() {
            return self.getIndex();
        }
    });
};
Node.prototype.setParent = function (nodes, parent) {
    function set(node) {
        if (node && node instanceof Node) {
            node.parent = parent;
        }
    }
    if (Array.isArray(nodes)) {
        nodes.forEach(set);
    } else {
        set(nodes);
    }
};
Node.prototype.getIndex = function () {
    return this._index || this.parent && this.parent.getIndex() || 0;
};
Node.prototype.fileInfo = function () {
    return this._fileInfo || this.parent && this.parent.fileInfo() || {};
};
Node.prototype.isRulesetLike = function () {
    return false;
};
Node.prototype.toCSS = function (context) {
    var strs = [];
    this.genCSS(context, {
        add: function add(chunk, fileInfo, index) {
            strs.push(chunk);
        },
        isEmpty: function isEmpty() {
            return strs.length === 0;
        }
    });
    return strs.join('');
};
Node.prototype.genCSS = function (context, output) {
    output.add(this.value);
};
Node.prototype.accept = function (visitor) {
    this.value = visitor.visit(this.value);
};
Node.prototype.eval = function () {
    return this;
};
Node.prototype._operate = function (context, op, a, b) {
    switch (op) {
        case '+':
            return a + b;
        case '-':
            return a - b;
        case '*':
            return a * b;
        case '/':
            return a / b;
    }
};
Node.prototype.fround = function (context, value) {
    var precision = context && context.numPrecision;
    //add "epsilon" to ensure numbers like 1.000000005 (represented as 1.000000004999....) are properly rounded...
    return precision == null ? value : Number((value + 2e-16).toFixed(precision));
};
Node.compare = function (a, b) {
    /* returns:
     -1: a < b
     0: a = b
     1: a > b
     and *any* other value for a != b (e.g. undefined, NaN, -2 etc.) */

    if (a.compare &&
    // for "symmetric results" force toCSS-based comparison
    // of Quoted or Anonymous if either value is one of those
    !(b.type === "Anonymous")) {
        return a.compare(b);
    } else if (b.compare) {
        return -b.compare(a);
    } else if (a.type !== b.type) {
        return undefined;
    }

    a = a.value;
    b = b.value;
    if (!Array.isArray(a)) {
        return a === b ? 0 : undefined;
    }
    if (a.length !== b.length) {
        return undefined;
    }
    for (var i = 0; i < a.length; i++) {
        if (Node.compare(a[i], b[i]) !== 0) {
            return undefined;
        }
    }
    return 0;
};

Node.numericCompare = function (a, b) {
    return a < b ? -1 : a === b ? 0 : a > b ? 1 : undefined;
};
// Returns true if this node represents root of ast imported by reference
Node.prototype.blocksVisibility = function () {
    if (this.visibilityBlocks == null) {
        this.visibilityBlocks = 0;
    }
    return this.visibilityBlocks !== 0;
};
Node.prototype.addVisibilityBlock = function () {
    if (this.visibilityBlocks == null) {
        this.visibilityBlocks = 0;
    }
    this.visibilityBlocks = this.visibilityBlocks + 1;
};
Node.prototype.removeVisibilityBlock = function () {
    if (this.visibilityBlocks == null) {
        this.visibilityBlocks = 0;
    }
    this.visibilityBlocks = this.visibilityBlocks - 1;
};
//Turns on node visibility - if called node will be shown in output regardless
//of whether it comes from import by reference or not
Node.prototype.ensureVisibility = function () {
    this.nodeVisible = true;
};
//Turns off node visibility - if called node will NOT be shown in output regardless
//of whether it comes from import by reference or not
Node.prototype.ensureInvisibility = function () {
    this.nodeVisible = false;
};
// return values:
// false - the node must not be visible
// true - the node must be visible
// undefined or null - the node has the same visibility as its parent
Node.prototype.isVisible = function () {
    return this.nodeVisible;
};
Node.prototype.visibilityInfo = function () {
    return {
        visibilityBlocks: this.visibilityBlocks,
        nodeVisible: this.nodeVisible
    };
};
Node.prototype.copyVisibilityInfo = function (info) {
    if (!info) {
        return;
    }
    this.visibilityBlocks = info.visibilityBlocks;
    this.nodeVisible = info.nodeVisible;
};
module.exports = Node;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90cmVlL25vZGUuanMiXSwibmFtZXMiOlsiTm9kZSIsInBhcmVudCIsInZpc2liaWxpdHlCbG9ja3MiLCJ1bmRlZmluZWQiLCJub2RlVmlzaWJsZSIsInJvb3ROb2RlIiwicGFyc2VkIiwic2VsZiIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZ2V0IiwiZmlsZUluZm8iLCJnZXRJbmRleCIsInByb3RvdHlwZSIsInNldFBhcmVudCIsIm5vZGVzIiwic2V0Iiwibm9kZSIsIkFycmF5IiwiaXNBcnJheSIsImZvckVhY2giLCJfaW5kZXgiLCJfZmlsZUluZm8iLCJpc1J1bGVzZXRMaWtlIiwidG9DU1MiLCJjb250ZXh0Iiwic3RycyIsImdlbkNTUyIsImFkZCIsImNodW5rIiwiaW5kZXgiLCJwdXNoIiwiaXNFbXB0eSIsImxlbmd0aCIsImpvaW4iLCJvdXRwdXQiLCJ2YWx1ZSIsImFjY2VwdCIsInZpc2l0b3IiLCJ2aXNpdCIsImV2YWwiLCJfb3BlcmF0ZSIsIm9wIiwiYSIsImIiLCJmcm91bmQiLCJwcmVjaXNpb24iLCJudW1QcmVjaXNpb24iLCJOdW1iZXIiLCJ0b0ZpeGVkIiwiY29tcGFyZSIsInR5cGUiLCJpIiwibnVtZXJpY0NvbXBhcmUiLCJibG9ja3NWaXNpYmlsaXR5IiwiYWRkVmlzaWJpbGl0eUJsb2NrIiwicmVtb3ZlVmlzaWJpbGl0eUJsb2NrIiwiZW5zdXJlVmlzaWJpbGl0eSIsImVuc3VyZUludmlzaWJpbGl0eSIsImlzVmlzaWJsZSIsInZpc2liaWxpdHlJbmZvIiwiY29weVZpc2liaWxpdHlJbmZvIiwiaW5mbyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSUEsT0FBTyxTQUFQQSxJQUFPLEdBQVc7QUFDbEIsU0FBS0MsTUFBTCxHQUFjLElBQWQ7QUFDQSxTQUFLQyxnQkFBTCxHQUF3QkMsU0FBeEI7QUFDQSxTQUFLQyxXQUFMLEdBQW1CRCxTQUFuQjtBQUNBLFNBQUtFLFFBQUwsR0FB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SixLQUFLYSxTQUFMLENBQWU2QyxrQkFBZixHQUFvQyxZQUFZO0FBQzVDLFNBQUt0RCxXQUFMLEdBQW1CLEtBQW5CO0FBQ0gsQ0FGRDtBQUdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0FKLEtBQUthLFNBQUwsQ0FBZThDLFNBQWYsR0FBMkIsWUFBWTtBQUNuQyxXQUFPLEtBQUt2RCxXQUFaO0FBQ0gsQ0FGRDtBQUdBSixLQUFLYSxTQUFMLENBQWUrQyxjQUFmLEdBQWdDLFlBQVc7QUFDdkMsV0FBTztBQUNIMUQsMEJBQWtCLEtBQUtBLGdCQURwQjtBQUVIRSxxQkFBYSxLQUFLQTtBQUZmLEtBQVA7QUFJSCxDQUxEO0FBTUFKLEtBQUthLFNBQUwsQ0FBZWdELGtCQUFmLEdBQW9DLFVBQVNDLElBQVQsRUFBZTtBQUMvQyxRQUFJLENBQUNBLElBQUwsRUFBVztBQUNQO0FBQ0g7QUFDRCxTQUFLNUQsZ0JBQUwsR0FBd0I0RCxLQUFLNUQsZ0JBQTdCO0FBQ0EsU0FBS0UsV0FBTCxHQUFtQjBELEtBQUsxRCxXQUF4QjtBQUNILENBTkQ7QUFPQTJELE9BQU9DLE9BQVAsR0FBaUJoRSxJQUFqQiIsImZpbGUiOiJub2RlLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIE5vZGUgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLnBhcmVudCA9IG51bGw7XG4gICAgdGhpcy52aXNpYmlsaXR5QmxvY2tzID0gdW5kZWZpbmVkO1xuICAgIHRoaXMubm9kZVZpc2libGUgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5yb290Tm9kZSA9IG51bGw7XG4gICAgdGhpcy5wYXJzZWQgPSBudWxsO1xuXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBcImN1cnJlbnRGaWxlSW5mb1wiLCB7XG4gICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBzZWxmLmZpbGVJbmZvKCk7IH1cbiAgICB9KTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgXCJpbmRleFwiLCB7XG4gICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBzZWxmLmdldEluZGV4KCk7IH1cbiAgICB9KTtcblxufTtcbk5vZGUucHJvdG90eXBlLnNldFBhcmVudCA9IGZ1bmN0aW9uKG5vZGVzLCBwYXJlbnQpIHtcbiAgICBmdW5jdGlvbiBzZXQobm9kZSkge1xuICAgICAgICBpZiAobm9kZSAmJiBub2RlIGluc3RhbmNlb2YgTm9kZSkge1xuICAgICAgICAgICAgbm9kZS5wYXJlbnQgPSBwYXJlbnQ7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZXMpKSB7XG4gICAgICAgIG5vZGVzLmZvckVhY2goc2V0KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHNldChub2Rlcyk7XG4gICAgfVxufTtcbk5vZGUucHJvdG90eXBlLmdldEluZGV4ID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2luZGV4IHx8ICh0aGlzLnBhcmVudCAmJiB0aGlzLnBhcmVudC5nZXRJbmRleCgpKSB8fCAwO1xufTtcbk5vZGUucHJvdG90eXBlLmZpbGVJbmZvID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2ZpbGVJbmZvIHx8ICh0aGlzLnBhcmVudCAmJiB0aGlzLnBhcmVudC5maWxlSW5mbygpKSB8fCB7fTtcbn07XG5Ob2RlLnByb3RvdHlwZS5pc1J1bGVzZXRMaWtlID0gZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZTsgfTtcbk5vZGUucHJvdG90eXBlLnRvQ1NTID0gZnVuY3Rpb24gKGNvbnRleHQpIHtcbiAgICB2YXIgc3RycyA9IFtdO1xuICAgIHRoaXMuZ2VuQ1NTKGNvbnRleHQsIHtcbiAgICAgICAgYWRkOiBmdW5jdGlvbihjaHVuaywgZmlsZUluZm8sIGluZGV4KSB7XG4gICAgICAgICAgICBzdHJzLnB1c2goY2h1bmspO1xuICAgICAgICB9LFxuICAgICAgICBpc0VtcHR5OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gc3Rycy5sZW5ndGggPT09IDA7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gc3Rycy5qb2luKCcnKTtcbn07XG5Ob2RlLnByb3RvdHlwZS5nZW5DU1MgPSBmdW5jdGlvbiAoY29udGV4dCwgb3V0cHV0KSB7XG4gICAgb3V0cHV0LmFkZCh0aGlzLnZhbHVlKTtcbn07XG5Ob2RlLnByb3RvdHlwZS5hY2NlcHQgPSBmdW5jdGlvbiAodmlzaXRvcikge1xuICAgIHRoaXMudmFsdWUgPSB2aXNpdG9yLnZpc2l0KHRoaXMudmFsdWUpO1xufTtcbk5vZGUucHJvdG90eXBlLmV2YWwgPSBmdW5jdGlvbiAoKSB7IHJldHVybiB0aGlzOyB9O1xuTm9kZS5wcm90b3R5cGUuX29wZXJhdGUgPSBmdW5jdGlvbiAoY29udGV4dCwgb3AsIGEsIGIpIHtcbiAgICBzd2l0Y2ggKG9wKSB7XG4gICAgICAgIGNhc2UgJysnOiByZXR1cm4gYSArIGI7XG4gICAgICAgIGNhc2UgJy0nOiByZXR1cm4gYSAtIGI7XG4gICAgICAgIGNhc2UgJyonOiByZXR1cm4gYSAqIGI7XG4gICAgICAgIGNhc2UgJy8nOiByZXR1cm4gYSAvIGI7XG4gICAgfVxufTtcbk5vZGUucHJvdG90eXBlLmZyb3VuZCA9IGZ1bmN0aW9uKGNvbnRleHQsIHZhbHVlKSB7XG4gICAgdmFyIHByZWNpc2lvbiA9IGNvbnRleHQgJiYgY29udGV4dC5udW1QcmVjaXNpb247XG4gICAgLy9hZGQgXCJlcHNpbG9uXCIgdG8gZW5zdXJlIG51bWJlcnMgbGlrZSAxLjAwMDAwMDAwNSAocmVwcmVzZW50ZWQgYXMgMS4wMDAwMDAwMDQ5OTkuLi4uKSBhcmUgcHJvcGVybHkgcm91bmRlZC4uLlxuICAgIHJldHVybiAocHJlY2lzaW9uID09IG51bGwpID8gdmFsdWUgOiBOdW1iZXIoKHZhbHVlICsgMmUtMTYpLnRvRml4ZWQocHJlY2lzaW9uKSk7XG59O1xuTm9kZS5jb21wYXJlID0gZnVuY3Rpb24gKGEsIGIpIHtcbiAgICAvKiByZXR1cm5zOlxuICAgICAtMTogYSA8IGJcbiAgICAgMDogYSA9IGJcbiAgICAgMTogYSA+IGJcbiAgICAgYW5kICphbnkqIG90aGVyIHZhbHVlIGZvciBhICE9IGIgKGUuZy4gdW5kZWZpbmVkLCBOYU4sIC0yIGV0Yy4pICovXG5cbiAgICBpZiAoKGEuY29tcGFyZSkgJiZcbiAgICAgICAgLy8gZm9yIFwic3ltbWV0cmljIHJlc3VsdHNcIiBmb3JjZSB0b0NTUy1iYXNlZCBjb21wYXJpc29uXG4gICAgICAgIC8vIG9mIFF1b3RlZCBvciBBbm9ueW1vdXMgaWYgZWl0aGVyIHZhbHVlIGlzIG9uZSBvZiB0aG9zZVxuICAgICAgICAhKGIudHlwZSA9PT0gXCJBbm9ueW1vdXNcIikpIHtcbiAgICAgICAgcmV0dXJuIGEuY29tcGFyZShiKTtcbiAgICB9IGVsc2UgaWYgKGIuY29tcGFyZSkge1xuICAgICAgICByZXR1cm4gLWIuY29tcGFyZShhKTtcbiAgICB9IGVsc2UgaWYgKGEudHlwZSAhPT0gYi50eXBlKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgYSA9IGEudmFsdWU7XG4gICAgYiA9IGIudmFsdWU7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGEpKSB7XG4gICAgICAgIHJldHVybiBhID09PSBiID8gMCA6IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgaWYgKGEubGVuZ3RoICE9PSBiLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKE5vZGUuY29tcGFyZShhW2ldLCBiW2ldKSAhPT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gMDtcbn07XG5cbk5vZGUubnVtZXJpY0NvbXBhcmUgPSBmdW5jdGlvbiAoYSwgYikge1xuICAgIHJldHVybiBhICA8ICBiID8gLTFcbiAgICAgICAgOiBhID09PSBiID8gIDBcbiAgICAgICAgOiBhICA+ICBiID8gIDEgOiB1bmRlZmluZWQ7XG59O1xuLy8gUmV0dXJucyB0cnVlIGlmIHRoaXMgbm9kZSByZXByZXNlbnRzIHJvb3Qgb2YgYXN0IGltcG9ydGVkIGJ5IHJlZmVyZW5jZVxuTm9kZS5wcm90b3R5cGUuYmxvY2tzVmlzaWJpbGl0eSA9IGZ1bmN0aW9uICgpIHtcbiAgICBpZiAodGhpcy52aXNpYmlsaXR5QmxvY2tzID09IG51bGwpIHtcbiAgICAgICAgdGhpcy52aXNpYmlsaXR5QmxvY2tzID0gMDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudmlzaWJpbGl0eUJsb2NrcyAhPT0gMDtcbn07XG5Ob2RlLnByb3RvdHlwZS5hZGRWaXNpYmlsaXR5QmxvY2sgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHRoaXMudmlzaWJpbGl0eUJsb2NrcyA9PSBudWxsKSB7XG4gICAgICAgIHRoaXMudmlzaWJpbGl0eUJsb2NrcyA9IDA7XG4gICAgfVxuICAgIHRoaXMudmlzaWJpbGl0eUJsb2NrcyA9IHRoaXMudmlzaWJpbGl0eUJsb2NrcyArIDE7XG59O1xuTm9kZS5wcm90b3R5cGUucmVtb3ZlVmlzaWJpbGl0eUJsb2NrID0gZnVuY3Rpb24gKCkge1xuICAgIGlmICh0aGlzLnZpc2liaWxpdHlCbG9ja3MgPT0gbnVsbCkge1xuICAgICAgICB0aGlzLnZpc2liaWxpdHlCbG9ja3MgPSAwO1xuICAgIH1cbiAgICB0aGlzLnZpc2liaWxpdHlCbG9ja3MgPSB0aGlzLnZpc2liaWxpdHlCbG9ja3MgLSAxO1xufTtcbi8vVHVybnMgb24gbm9kZSB2aXNpYmlsaXR5IC0gaWYgY2FsbGVkIG5vZGUgd2lsbCBiZSBzaG93biBpbiBvdXRwdXQgcmVnYXJkbGVzc1xuLy9vZiB3aGV0aGVyIGl0IGNvbWVzIGZyb20gaW1wb3J0IGJ5IHJlZmVyZW5jZSBvciBub3Rcbk5vZGUucHJvdG90eXBlLmVuc3VyZVZpc2liaWxpdHkgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5ub2RlVmlzaWJsZSA9IHRydWU7XG59O1xuLy9UdXJucyBvZmYgbm9kZSB2aXNpYmlsaXR5IC0gaWYgY2FsbGVkIG5vZGUgd2lsbCBOT1QgYmUgc2hvd24gaW4gb3V0cHV0IHJlZ2FyZGxlc3Ncbi8vb2Ygd2hldGhlciBpdCBjb21lcyBmcm9tIGltcG9ydCBieSByZWZlcmVuY2Ugb3Igbm90XG5Ob2RlLnByb3RvdHlwZS5lbnN1cmVJbnZpc2liaWxpdHkgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5ub2RlVmlzaWJsZSA9IGZhbHNlO1xufTtcbi8vIHJldHVybiB2YWx1ZXM6XG4vLyBmYWxzZSAtIHRoZSBub2RlIG11c3Qgbm90IGJlIHZpc2libGVcbi8vIHRydWUgLSB0aGUgbm9kZSBtdXN0IGJlIHZpc2libGVcbi8vIHVuZGVmaW5lZCBvciBudWxsIC0gdGhlIG5vZGUgaGFzIHRoZSBzYW1lIHZpc2liaWxpdHkgYXMgaXRzIHBhcmVudFxuTm9kZS5wcm90b3R5cGUuaXNWaXNpYmxlID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0aGlzLm5vZGVWaXNpYmxlO1xufTtcbk5vZGUucHJvdG90eXBlLnZpc2liaWxpdHlJbmZvID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgdmlzaWJpbGl0eUJsb2NrczogdGhpcy52aXNpYmlsaXR5QmxvY2tzLFxuICAgICAgICBub2RlVmlzaWJsZTogdGhpcy5ub2RlVmlzaWJsZVxuICAgIH07XG59O1xuTm9kZS5wcm90b3R5cGUuY29weVZpc2liaWxpdHlJbmZvID0gZnVuY3Rpb24oaW5mbykge1xuICAgIGlmICghaW5mbykge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMudmlzaWJpbGl0eUJsb2NrcyA9IGluZm8udmlzaWJpbGl0eUJsb2NrcztcbiAgICB0aGlzLm5vZGVWaXNpYmxlID0gaW5mby5ub2RlVmlzaWJsZTtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IE5vZGU7XG4iXX0=