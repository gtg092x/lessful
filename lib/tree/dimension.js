"use strict";

var Node = require("./node"),
    unitConversions = require("../data/unit-conversions"),
    Unit = require("./unit"),
    Color = require("./color");

//
// A number with a unit
//
var Dimension = function Dimension(value, unit) {
    this.value = parseFloat(value);
    this.unit = unit && unit instanceof Unit ? unit : new Unit(unit ? [unit] : undefined);
    this.setParent(this.unit, this);
};

Dimension.prototype = new Node();
Dimension.prototype.type = "Dimension";
Dimension.prototype.accept = function (visitor) {
    this.unit = visitor.visit(this.unit);
};
Dimension.prototype.eval = function (context) {
    return this;
};
Dimension.prototype.toColor = function () {
    return new Color([this.value, this.value, this.value]);
};
Dimension.prototype.genCSS = function (context, output) {
    if (context && context.strictUnits && !this.unit.isSingular()) {
        throw new Error("Multiple units in dimension. Correct the units or use the unit function. Bad unit: " + this.unit.toString());
    }

    var value = this.fround(context, this.value),
        strValue = String(value);

    if (value !== 0 && value < 0.000001 && value > -0.000001) {
        // would be output 1e-6 etc.
        strValue = value.toFixed(20).replace(/0+$/, "");
    }

    if (context && context.compress) {
        // Zero values doesn't need a unit
        if (value === 0 && this.unit.isLength()) {
            output.add(strValue);
            return;
        }

        // Float values doesn't need a leading zero
        if (value > 0 && value < 1) {
            strValue = strValue.substr(1);
        }
    }

    output.add(strValue);
    this.unit.genCSS(context, output);
};

// In an operation between two Dimensions,
// we default to the first Dimension's unit,
// so `1px + 2` will yield `3px`.
Dimension.prototype.operate = function (context, op, other) {
    /*jshint noempty:false */
    var value = this._operate(context, op, this.value, other.value),
        unit = this.unit.clone();

    if (op === '+' || op === '-') {
        if (unit.numerator.length === 0 && unit.denominator.length === 0) {
            unit = other.unit.clone();
            if (this.unit.backupUnit) {
                unit.backupUnit = this.unit.backupUnit;
            }
        } else if (other.unit.numerator.length === 0 && unit.denominator.length === 0) {
            // do nothing
        } else {
            other = other.convertTo(this.unit.usedUnits());

            if (context.strictUnits && other.unit.toString() !== unit.toString()) {
                throw new Error("Incompatible units. Change the units or use the unit function. Bad units: '" + unit.toString() + "' and '" + other.unit.toString() + "'.");
            }

            value = this._operate(context, op, this.value, other.value);
        }
    } else if (op === '*') {
        unit.numerator = unit.numerator.concat(other.unit.numerator).sort();
        unit.denominator = unit.denominator.concat(other.unit.denominator).sort();
        unit.cancel();
    } else if (op === '/') {
        unit.numerator = unit.numerator.concat(other.unit.denominator).sort();
        unit.denominator = unit.denominator.concat(other.unit.numerator).sort();
        unit.cancel();
    }
    return new Dimension(value, unit);
};
Dimension.prototype.compare = function (other) {
    var a, b;

    if (!(other instanceof Dimension)) {
        return undefined;
    }

    if (this.unit.isEmpty() || other.unit.isEmpty()) {
        a = this;
        b = other;
    } else {
        a = this.unify();
        b = other.unify();
        if (a.unit.compare(b.unit) !== 0) {
            return undefined;
        }
    }

    return Node.numericCompare(a.value, b.value);
};
Dimension.prototype.unify = function () {
    return this.convertTo({ length: 'px', duration: 's', angle: 'rad' });
};
Dimension.prototype.convertTo = function (conversions) {
    var value = this.value,
        unit = this.unit.clone(),
        i,
        groupName,
        group,
        targetUnit,
        derivedConversions = {},
        applyUnit;

    if (typeof conversions === 'string') {
        for (i in unitConversions) {
            if (unitConversions[i].hasOwnProperty(conversions)) {
                derivedConversions = {};
                derivedConversions[i] = conversions;
            }
        }
        conversions = derivedConversions;
    }
    applyUnit = function applyUnit(atomicUnit, denominator) {
        /* jshint loopfunc:true */
        if (group.hasOwnProperty(atomicUnit)) {
            if (denominator) {
                value = value / (group[atomicUnit] / group[targetUnit]);
            } else {
                value = value * (group[atomicUnit] / group[targetUnit]);
            }

            return targetUnit;
        }

        return atomicUnit;
    };

    for (groupName in conversions) {
        if (conversions.hasOwnProperty(groupName)) {
            targetUnit = conversions[groupName];
            group = unitConversions[groupName];

            unit.map(applyUnit);
        }
    }

    unit.cancel();

    return new Dimension(value, unit);
};
module.exports = Dimension;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90cmVlL2RpbWVuc2lvbi5qcyJdLCJuYW1lcyI6WyJOb2RlIiwicmVxdWlyZSIsInVuaXRDb252ZXJzaW9ucyIsIlVuaXQiLCJDb2xvciIsIkRpbWVuc2lvbiIsInZhbHVlIiwidW5pdCIsInBhcnNlRmxvYXQiLCJ1bmRlZmluZWQiLCJzZXRQYXJlbnQiLCJwcm90b3R5cGUiLCJ0eXBlIiwiYWNjZXB0IiwidmlzaXRvciIsInZpc2l0IiwiZXZhbCIsImNvbnRleHQiLCJ0b0NvbG9yIiwiZ2VuQ1NTIiwib3V0cHV0Iiwic3RyaWN0VW5pdHMiLCJpc1Npbmd1bGFyIiwiRXJyb3IiLCJ0b1N0cmluZyIsImZyb3VuZCIsInN0clZhbHVlIiwiU3RyaW5nIiwidG9GaXhlZCIsInJlcGxhY2UiLCJjb21wcmVzcyIsImlzTGVuZ3RoIiwiYWRkIiwic3Vic3RyIiwib3BlcmF0ZSIsIm9wIiwib3RoZXIiLCJfb3BlcmF0ZSIsImNsb25lIiwibnVtZXJhdG9yIiwibGVuZ3RoIiwiZGVub21pbmF0b3IiLCJiYWNrdXBVbml0IiwiY29udmVydFRvIiwidXNlZFVuaXRzIiwiY29uY2F0Iiwic29ydCIsImNhbmNlbCIsImNvbXBhcmUiLCJhIiwiYiIsImlzRW1wdHkiLCJ1bmlmeSIsIm51bWVyaWNDb21wYXJlIiwiZHVyYXRpb24iLCJhbmdsZSIsImNvbnZlcnNpb25zIiwiaSIsImdyb3VwTmFtZSIsImdyb3VwIiwidGFyZ2V0VW5pdCIsImRlcml2ZWRDb252ZXJzaW9ucyIsImFwcGx5VW5pdCIsImhhc093blByb3BlcnR5IiwiYXRvbWljVW5pdCIsIm1hcCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSUEsT0FBT0MsUUFBUSxRQUFSLENBQVg7QUFBQSxJQUNJQyxrQkFBa0JELFFBQVEsMEJBQVIsQ0FEdEI7QUFBQSxJQUVJRSxPQUFPRixRQUFRLFFBQVIsQ0FGWDtBQUFBLElBR0lHLFFBQVFILFFBQVEsU0FBUixDQUhaOztB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QSxTQUFTcUQsTUFBTUssVUFBTixJQUFvQkwsTUFBTUMsVUFBTixDQUE3QixDQUFSO0FBQ0g7O0FBRUQsbUJBQU9BLFVBQVA7QUFDSDs7QUFFRCxlQUFPSSxVQUFQO0FBQ0gsS0FiRDs7QUFlQSxTQUFLTixTQUFMLElBQWtCRixXQUFsQixFQUErQjtBQUMzQixZQUFJQSxZQUFZTyxjQUFaLENBQTJCTCxTQUEzQixDQUFKLEVBQTJDO0FBQ3ZDRSx5QkFBYUosWUFBWUUsU0FBWixDQUFiO0FBQ0FDLG9CQUFRekQsZ0JBQWdCd0QsU0FBaEIsQ0FBUjs7QUFFQW5ELGlCQUFLMEQsR0FBTCxDQUFTSCxTQUFUO0FBQ0g7QUFDSjs7QUFFRHZELFNBQUt3QyxNQUFMOztBQUVBLFdBQU8sSUFBSTFDLFNBQUosQ0FBY0MsS0FBZCxFQUFxQkMsSUFBckIsQ0FBUDtBQUNILENBeENEO0FBeUNBMkQsT0FBT0MsT0FBUCxHQUFpQjlELFNBQWpCIiwiZmlsZSI6ImRpbWVuc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBOb2RlID0gcmVxdWlyZShcIi4vbm9kZVwiKSxcbiAgICB1bml0Q29udmVyc2lvbnMgPSByZXF1aXJlKFwiLi4vZGF0YS91bml0LWNvbnZlcnNpb25zXCIpLFxuICAgIFVuaXQgPSByZXF1aXJlKFwiLi91bml0XCIpLFxuICAgIENvbG9yID0gcmVxdWlyZShcIi4vY29sb3JcIik7XG5cbi8vXG4vLyBBIG51bWJlciB3aXRoIGEgdW5pdFxuLy9cbnZhciBEaW1lbnNpb24gPSBmdW5jdGlvbiAodmFsdWUsIHVuaXQpIHtcbiAgICB0aGlzLnZhbHVlID0gcGFyc2VGbG9hdCh2YWx1ZSk7XG4gICAgdGhpcy51bml0ID0gKHVuaXQgJiYgdW5pdCBpbnN0YW5jZW9mIFVuaXQpID8gdW5pdCA6XG4gICAgICBuZXcgVW5pdCh1bml0ID8gW3VuaXRdIDogdW5kZWZpbmVkKTtcbiAgICB0aGlzLnNldFBhcmVudCh0aGlzLnVuaXQsIHRoaXMpO1xufTtcblxuRGltZW5zaW9uLnByb3RvdHlwZSA9IG5ldyBOb2RlKCk7XG5EaW1lbnNpb24ucHJvdG90eXBlLnR5cGUgPSBcIkRpbWVuc2lvblwiO1xuRGltZW5zaW9uLnByb3RvdHlwZS5hY2NlcHQgPSBmdW5jdGlvbiAodmlzaXRvcikge1xuICAgIHRoaXMudW5pdCA9IHZpc2l0b3IudmlzaXQodGhpcy51bml0KTtcbn07XG5EaW1lbnNpb24ucHJvdG90eXBlLmV2YWwgPSBmdW5jdGlvbiAoY29udGV4dCkge1xuICAgIHJldHVybiB0aGlzO1xufTtcbkRpbWVuc2lvbi5wcm90b3R5cGUudG9Db2xvciA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gbmV3IENvbG9yKFt0aGlzLnZhbHVlLCB0aGlzLnZhbHVlLCB0aGlzLnZhbHVlXSk7XG59O1xuRGltZW5zaW9uLnByb3RvdHlwZS5nZW5DU1MgPSBmdW5jdGlvbiAoY29udGV4dCwgb3V0cHV0KSB7XG4gICAgaWYgKChjb250ZXh0ICYmIGNvbnRleHQuc3RyaWN0VW5pdHMpICYmICF0aGlzLnVuaXQuaXNTaW5ndWxhcigpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIk11bHRpcGxlIHVuaXRzIGluIGRpbWVuc2lvbi4gQ29ycmVjdCB0aGUgdW5pdHMgb3IgdXNlIHRoZSB1bml0IGZ1bmN0aW9uLiBCYWQgdW5pdDogXCIgKyB0aGlzLnVuaXQudG9TdHJpbmcoKSk7XG4gICAgfVxuXG4gICAgdmFyIHZhbHVlID0gdGhpcy5mcm91bmQoY29udGV4dCwgdGhpcy52YWx1ZSksXG4gICAgICAgIHN0clZhbHVlID0gU3RyaW5nKHZhbHVlKTtcblxuICAgIGlmICh2YWx1ZSAhPT0gMCAmJiB2YWx1ZSA8IDAuMDAwMDAxICYmIHZhbHVlID4gLTAuMDAwMDAxKSB7XG4gICAgICAgIC8vIHdvdWxkIGJlIG91dHB1dCAxZS02IGV0Yy5cbiAgICAgICAgc3RyVmFsdWUgPSB2YWx1ZS50b0ZpeGVkKDIwKS5yZXBsYWNlKC8wKyQvLCBcIlwiKTtcbiAgICB9XG5cbiAgICBpZiAoY29udGV4dCAmJiBjb250ZXh0LmNvbXByZXNzKSB7XG4gICAgICAgIC8vIFplcm8gdmFsdWVzIGRvZXNuJ3QgbmVlZCBhIHVuaXRcbiAgICAgICAgaWYgKHZhbHVlID09PSAwICYmIHRoaXMudW5pdC5pc0xlbmd0aCgpKSB7XG4gICAgICAgICAgICBvdXRwdXQuYWRkKHN0clZhbHVlKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEZsb2F0IHZhbHVlcyBkb2Vzbid0IG5lZWQgYSBsZWFkaW5nIHplcm9cbiAgICAgICAgaWYgKHZhbHVlID4gMCAmJiB2YWx1ZSA8IDEpIHtcbiAgICAgICAgICAgIHN0clZhbHVlID0gKHN0clZhbHVlKS5zdWJzdHIoMSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvdXRwdXQuYWRkKHN0clZhbHVlKTtcbiAgICB0aGlzLnVuaXQuZ2VuQ1NTKGNvbnRleHQsIG91dHB1dCk7XG59O1xuXG4vLyBJbiBhbiBvcGVyYXRpb24gYmV0d2VlbiB0d28gRGltZW5zaW9ucyxcbi8vIHdlIGRlZmF1bHQgdG8gdGhlIGZpcnN0IERpbWVuc2lvbidzIHVuaXQsXG4vLyBzbyBgMXB4ICsgMmAgd2lsbCB5aWVsZCBgM3B4YC5cbkRpbWVuc2lvbi5wcm90b3R5cGUub3BlcmF0ZSA9IGZ1bmN0aW9uIChjb250ZXh0LCBvcCwgb3RoZXIpIHtcbiAgICAvKmpzaGludCBub2VtcHR5OmZhbHNlICovXG4gICAgdmFyIHZhbHVlID0gdGhpcy5fb3BlcmF0ZShjb250ZXh0LCBvcCwgdGhpcy52YWx1ZSwgb3RoZXIudmFsdWUpLFxuICAgICAgICB1bml0ID0gdGhpcy51bml0LmNsb25lKCk7XG5cbiAgICBpZiAob3AgPT09ICcrJyB8fCBvcCA9PT0gJy0nKSB7XG4gICAgICAgIGlmICh1bml0Lm51bWVyYXRvci5sZW5ndGggPT09IDAgJiYgdW5pdC5kZW5vbWluYXRvci5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHVuaXQgPSBvdGhlci51bml0LmNsb25lKCk7XG4gICAgICAgICAgICBpZiAodGhpcy51bml0LmJhY2t1cFVuaXQpIHtcbiAgICAgICAgICAgICAgICB1bml0LmJhY2t1cFVuaXQgPSB0aGlzLnVuaXQuYmFja3VwVW5pdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChvdGhlci51bml0Lm51bWVyYXRvci5sZW5ndGggPT09IDAgJiYgdW5pdC5kZW5vbWluYXRvci5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG90aGVyID0gb3RoZXIuY29udmVydFRvKHRoaXMudW5pdC51c2VkVW5pdHMoKSk7XG5cbiAgICAgICAgICAgIGlmIChjb250ZXh0LnN0cmljdFVuaXRzICYmIG90aGVyLnVuaXQudG9TdHJpbmcoKSAhPT0gdW5pdC50b1N0cmluZygpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW5jb21wYXRpYmxlIHVuaXRzLiBDaGFuZ2UgdGhlIHVuaXRzIG9yIHVzZSB0aGUgdW5pdCBmdW5jdGlvbi4gQmFkIHVuaXRzOiAnXCIgKyB1bml0LnRvU3RyaW5nKCkgK1xuICAgICAgICAgICAgICAgICAgICBcIicgYW5kICdcIiArIG90aGVyLnVuaXQudG9TdHJpbmcoKSArIFwiJy5cIik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHZhbHVlID0gdGhpcy5fb3BlcmF0ZShjb250ZXh0LCBvcCwgdGhpcy52YWx1ZSwgb3RoZXIudmFsdWUpO1xuICAgICAgICB9XG4gICAgfSBlbHNlIGlmIChvcCA9PT0gJyonKSB7XG4gICAgICAgIHVuaXQubnVtZXJhdG9yID0gdW5pdC5udW1lcmF0b3IuY29uY2F0KG90aGVyLnVuaXQubnVtZXJhdG9yKS5zb3J0KCk7XG4gICAgICAgIHVuaXQuZGVub21pbmF0b3IgPSB1bml0LmRlbm9taW5hdG9yLmNvbmNhdChvdGhlci51bml0LmRlbm9taW5hdG9yKS5zb3J0KCk7XG4gICAgICAgIHVuaXQuY2FuY2VsKCk7XG4gICAgfSBlbHNlIGlmIChvcCA9PT0gJy8nKSB7XG4gICAgICAgIHVuaXQubnVtZXJhdG9yID0gdW5pdC5udW1lcmF0b3IuY29uY2F0KG90aGVyLnVuaXQuZGVub21pbmF0b3IpLnNvcnQoKTtcbiAgICAgICAgdW5pdC5kZW5vbWluYXRvciA9IHVuaXQuZGVub21pbmF0b3IuY29uY2F0KG90aGVyLnVuaXQubnVtZXJhdG9yKS5zb3J0KCk7XG4gICAgICAgIHVuaXQuY2FuY2VsKCk7XG4gICAgfVxuICAgIHJldHVybiBuZXcgRGltZW5zaW9uKHZhbHVlLCB1bml0KTtcbn07XG5EaW1lbnNpb24ucHJvdG90eXBlLmNvbXBhcmUgPSBmdW5jdGlvbiAob3RoZXIpIHtcbiAgICB2YXIgYSwgYjtcblxuICAgIGlmICghKG90aGVyIGluc3RhbmNlb2YgRGltZW5zaW9uKSkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnVuaXQuaXNFbXB0eSgpIHx8IG90aGVyLnVuaXQuaXNFbXB0eSgpKSB7XG4gICAgICAgIGEgPSB0aGlzO1xuICAgICAgICBiID0gb3RoZXI7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgYSA9IHRoaXMudW5pZnkoKTtcbiAgICAgICAgYiA9IG90aGVyLnVuaWZ5KCk7XG4gICAgICAgIGlmIChhLnVuaXQuY29tcGFyZShiLnVuaXQpICE9PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIE5vZGUubnVtZXJpY0NvbXBhcmUoYS52YWx1ZSwgYi52YWx1ZSk7XG59O1xuRGltZW5zaW9uLnByb3RvdHlwZS51bmlmeSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy5jb252ZXJ0VG8oeyBsZW5ndGg6ICdweCcsIGR1cmF0aW9uOiAncycsIGFuZ2xlOiAncmFkJyB9KTtcbn07XG5EaW1lbnNpb24ucHJvdG90eXBlLmNvbnZlcnRUbyA9IGZ1bmN0aW9uIChjb252ZXJzaW9ucykge1xuICAgIHZhciB2YWx1ZSA9IHRoaXMudmFsdWUsIHVuaXQgPSB0aGlzLnVuaXQuY2xvbmUoKSxcbiAgICAgICAgaSwgZ3JvdXBOYW1lLCBncm91cCwgdGFyZ2V0VW5pdCwgZGVyaXZlZENvbnZlcnNpb25zID0ge30sIGFwcGx5VW5pdDtcblxuICAgIGlmICh0eXBlb2YgY29udmVyc2lvbnMgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGZvciAoaSBpbiB1bml0Q29udmVyc2lvbnMpIHtcbiAgICAgICAgICAgIGlmICh1bml0Q29udmVyc2lvbnNbaV0uaGFzT3duUHJvcGVydHkoY29udmVyc2lvbnMpKSB7XG4gICAgICAgICAgICAgICAgZGVyaXZlZENvbnZlcnNpb25zID0ge307XG4gICAgICAgICAgICAgICAgZGVyaXZlZENvbnZlcnNpb25zW2ldID0gY29udmVyc2lvbnM7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29udmVyc2lvbnMgPSBkZXJpdmVkQ29udmVyc2lvbnM7XG4gICAgfVxuICAgIGFwcGx5VW5pdCA9IGZ1bmN0aW9uIChhdG9taWNVbml0LCBkZW5vbWluYXRvcikge1xuICAgICAgICAvKiBqc2hpbnQgbG9vcGZ1bmM6dHJ1ZSAqL1xuICAgICAgICBpZiAoZ3JvdXAuaGFzT3duUHJvcGVydHkoYXRvbWljVW5pdCkpIHtcbiAgICAgICAgICAgIGlmIChkZW5vbWluYXRvcikge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUgLyAoZ3JvdXBbYXRvbWljVW5pdF0gLyBncm91cFt0YXJnZXRVbml0XSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUgKiAoZ3JvdXBbYXRvbWljVW5pdF0gLyBncm91cFt0YXJnZXRVbml0XSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB0YXJnZXRVbml0O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGF0b21pY1VuaXQ7XG4gICAgfTtcblxuICAgIGZvciAoZ3JvdXBOYW1lIGluIGNvbnZlcnNpb25zKSB7XG4gICAgICAgIGlmIChjb252ZXJzaW9ucy5oYXNPd25Qcm9wZXJ0eShncm91cE5hbWUpKSB7XG4gICAgICAgICAgICB0YXJnZXRVbml0ID0gY29udmVyc2lvbnNbZ3JvdXBOYW1lXTtcbiAgICAgICAgICAgIGdyb3VwID0gdW5pdENvbnZlcnNpb25zW2dyb3VwTmFtZV07XG5cbiAgICAgICAgICAgIHVuaXQubWFwKGFwcGx5VW5pdCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB1bml0LmNhbmNlbCgpO1xuXG4gICAgcmV0dXJuIG5ldyBEaW1lbnNpb24odmFsdWUsIHVuaXQpO1xufTtcbm1vZHVsZS5leHBvcnRzID0gRGltZW5zaW9uO1xuIl19