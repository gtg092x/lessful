"use strict";

var Node = require("./node"),
    unitConversions = require("../data/unit-conversions"),
    Unit = require("./unit"),
    Color = require("./color");

//
// A number with a unit
//
var Dimension = function Dimension(value, unit) {
    this.value = parseFloat(value);
    this.unit = unit && unit instanceof Unit ? unit : new Unit(unit ? [unit] : undefined);
    this.setParent(this.unit, this);
};

Dimension.prototype = new Node();
Dimension.prototype.type = "Dimension";
Dimension.prototype.accept = function (visitor) {
    this.unit = visitor.visit(this.unit);
};
Dimension.prototype.eval = function () {
    return this;
};
Dimension.prototype.toColor = function () {
    return new Color([this.value, this.value, this.value]);
};
Dimension.prototype.genCSS = function (context, output) {
    if (context && context.strictUnits && !this.unit.isSingular()) {
        throw new Error("Multiple units in dimension. Correct the units or use the unit function. Bad unit: " + this.unit.toString());
    }

    var value = this.fround(context, this.value),
        strValue = String(value);

    if (value !== 0 && value < 0.000001 && value > -0.000001) {
        // would be output 1e-6 etc.
        strValue = value.toFixed(20).replace(/0+$/, "");
    }

    if (context && context.compress) {
        // Zero values doesn't need a unit
        if (value === 0 && this.unit.isLength()) {
            output.add(strValue);
            return;
        }

        // Float values doesn't need a leading zero
        if (value > 0 && value < 1) {
            strValue = strValue.substr(1);
        }
    }

    output.add(strValue);
    this.unit.genCSS(context, output);
};

// In an operation between two Dimensions,
// we default to the first Dimension's unit,
// so `1px + 2` will yield `3px`.
Dimension.prototype.operate = function (context, op, other) {
    /*jshint noempty:false */
    var value = this._operate(context, op, this.value, other.value),
        unit = this.unit.clone();

    if (op === '+' || op === '-') {
        if (unit.numerator.length === 0 && unit.denominator.length === 0) {
            unit = other.unit.clone();
            if (this.unit.backupUnit) {
                unit.backupUnit = this.unit.backupUnit;
            }
        } else if (other.unit.numerator.length === 0 && unit.denominator.length === 0) {
            // do nothing
        } else {
            other = other.convertTo(this.unit.usedUnits());

            if (context.strictUnits && other.unit.toString() !== unit.toString()) {
                throw new Error("Incompatible units. Change the units or use the unit function. Bad units: '" + unit.toString() + "' and '" + other.unit.toString() + "'.");
            }

            value = this._operate(context, op, this.value, other.value);
        }
    } else if (op === '*') {
        unit.numerator = unit.numerator.concat(other.unit.numerator).sort();
        unit.denominator = unit.denominator.concat(other.unit.denominator).sort();
        unit.cancel();
    } else if (op === '/') {
        unit.numerator = unit.numerator.concat(other.unit.denominator).sort();
        unit.denominator = unit.denominator.concat(other.unit.numerator).sort();
        unit.cancel();
    }
    return new Dimension(value, unit);
};
Dimension.prototype.compare = function (other) {
    var a, b;

    if (!(other instanceof Dimension)) {
        return undefined;
    }

    if (this.unit.isEmpty() || other.unit.isEmpty()) {
        a = this;
        b = other;
    } else {
        a = this.unify();
        b = other.unify();
        if (a.unit.compare(b.unit) !== 0) {
            return undefined;
        }
    }

    return Node.numericCompare(a.value, b.value);
};
Dimension.prototype.unify = function () {
    return this.convertTo({ length: 'px', duration: 's', angle: 'rad' });
};
Dimension.prototype.convertTo = function (conversions) {
    var value = this.value,
        unit = this.unit.clone(),
        i,
        groupName,
        group,
        targetUnit,
        derivedConversions = {},
        applyUnit;

    if (typeof conversions === 'string') {
        for (i in unitConversions) {
            if (unitConversions[i].hasOwnProperty(conversions)) {
                derivedConversions = {};
                derivedConversions[i] = conversions;
            }
        }
        conversions = derivedConversions;
    }
    applyUnit = function applyUnit(atomicUnit, denominator) {
        /* jshint loopfunc:true */
        if (group.hasOwnProperty(atomicUnit)) {
            if (denominator) {
                value = value / (group[atomicUnit] / group[targetUnit]);
            } else {
                value = value * (group[atomicUnit] / group[targetUnit]);
            }

            return targetUnit;
        }

        return atomicUnit;
    };

    for (groupName in conversions) {
        if (conversions.hasOwnProperty(groupName)) {
            targetUnit = conversions[groupName];
            group = unitConversions[groupName];

            unit.map(applyUnit);
        }
    }

    unit.cancel();

    return new Dimension(value, unit);
};
module.exports = Dimension;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90cmVlL2RpbWVuc2lvbi5qcyJdLCJuYW1lcyI6WyJOb2RlIiwicmVxdWlyZSIsInVuaXRDb252ZXJzaW9ucyIsIlVuaXQiLCJDb2xvciIsIkRpbWVuc2lvbiIsInZhbHVlIiwidW5pdCIsInBhcnNlRmxvYXQiLCJ1bmRlZmluZWQiLCJzZXRQYXJlbnQiLCJwcm90b3R5cGUiLCJ0eXBlIiwiYWNjZXB0IiwidmlzaXRvciIsInZpc2l0IiwiZXZhbCIsInRvQ29sb3IiLCJnZW5DU1MiLCJjb250ZXh0Iiwib3V0cHV0Iiwic3RyaWN0VW5pdHMiLCJpc1Npbmd1bGFyIiwiRXJyb3IiLCJ0b1N0cmluZyIsImZyb3VuZCIsInN0clZhbHVlIiwiU3RyaW5nIiwidG9GaXhlZCIsInJlcGxhY2UiLCJjb21wcmVzcyIsImlzTGVuZ3RoIiwiYWRkIiwic3Vic3RyIiwib3BlcmF0ZSIsIm9wIiwib3RoZXIiLCJfb3BlcmF0ZSIsImNsb25lIiwibnVtZXJhdG9yIiwibGVuZ3RoIiwiZGVub21pbmF0b3IiLCJiYWNrdXBVbml0IiwiY29udmVydFRvIiwidXNlZFVuaXRzIiwiY29uY2F0Iiwic29ydCIsImNhbmNlbCIsImNvbXBhcmUiLCJhIiwiYiIsImlzRW1wdHkiLCJ1bmlmeSIsIm51bWVyaWNDb21wYXJlIiwiZHVyYXRpb24iLCJhbmdsZSIsImNvbnZlcnNpb25zIiwiaSIsImdyb3VwTmFtZSIsImdyb3VwIiwidGFyZ2V0VW5pdCIsImRlcml2ZWRDb252ZXJzaW9ucyIsImFwcGx5VW5pdCIsImhhc093blByb3BlcnR5IiwiYXRvbWljVW5pdCIsIm1hcCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSUEsT0FBT0MsUUFBUSxRQUFSLENBQVg7QUFBQSxJQUNJQyxrQkFBa0JELFFBQVEsMEJBQVIsQ0FEdEI7QUFBQSxJQUVJRSxPQUFPRixRQUFRLFFBQVIsQ0FGWDtBQUFBLElBR0lHLFFBQVFILFFBQVEsU0FBUixDQUhaOztB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SyxVQUFOLElBQW9CTCxNQUFNQyxVQUFOLENBQTdCLENBQVI7QUFDSDs7QUFFRCxtQkFBT0EsVUFBUDtBQUNIOztBQUVELGVBQU9JLFVBQVA7QUFDSCxLQWJEOztBQWVBLFNBQUtOLFNBQUwsSUFBa0JGLFdBQWxCLEVBQStCO0FBQzNCLFlBQUlBLFlBQVlPLGNBQVosQ0FBMkJMLFNBQTNCLENBQUosRUFBMkM7QUFDdkNFLHlCQUFhSixZQUFZRSxTQUFaLENBQWI7QUFDQUMsb0JBQVF6RCxnQkFBZ0J3RCxTQUFoQixDQUFSOztBQUVBbkQsaUJBQUswRCxHQUFMLENBQVNILFNBQVQ7QUFDSDtBQUNKOztBQUVEdkQsU0FBS3dDLE1BQUw7O0FBRUEsV0FBTyxJQUFJMUMsU0FBSixDQUFjQyxLQUFkLEVBQXFCQyxJQUFyQixDQUFQO0FBQ0gsQ0F4Q0Q7QUF5Q0EyRCxPQUFPQyxPQUFQLEdBQWlCOUQsU0FBakIiLCJmaWxlIjoiZGltZW5zaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIE5vZGUgPSByZXF1aXJlKFwiLi9ub2RlXCIpLFxuICAgIHVuaXRDb252ZXJzaW9ucyA9IHJlcXVpcmUoXCIuLi9kYXRhL3VuaXQtY29udmVyc2lvbnNcIiksXG4gICAgVW5pdCA9IHJlcXVpcmUoXCIuL3VuaXRcIiksXG4gICAgQ29sb3IgPSByZXF1aXJlKFwiLi9jb2xvclwiKTtcblxuLy9cbi8vIEEgbnVtYmVyIHdpdGggYSB1bml0XG4vL1xudmFyIERpbWVuc2lvbiA9IGZ1bmN0aW9uICh2YWx1ZSwgdW5pdCkge1xuICAgIHRoaXMudmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTtcbiAgICB0aGlzLnVuaXQgPSAodW5pdCAmJiB1bml0IGluc3RhbmNlb2YgVW5pdCkgPyB1bml0IDpcbiAgICAgIG5ldyBVbml0KHVuaXQgPyBbdW5pdF0gOiB1bmRlZmluZWQpO1xuICAgIHRoaXMuc2V0UGFyZW50KHRoaXMudW5pdCwgdGhpcyk7XG59O1xuXG5EaW1lbnNpb24ucHJvdG90eXBlID0gbmV3IE5vZGUoKTtcbkRpbWVuc2lvbi5wcm90b3R5cGUudHlwZSA9IFwiRGltZW5zaW9uXCI7XG5EaW1lbnNpb24ucHJvdG90eXBlLmFjY2VwdCA9IGZ1bmN0aW9uICh2aXNpdG9yKSB7XG4gICAgdGhpcy51bml0ID0gdmlzaXRvci52aXNpdCh0aGlzLnVuaXQpO1xufTtcbkRpbWVuc2lvbi5wcm90b3R5cGUuZXZhbCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcztcbn07XG5EaW1lbnNpb24ucHJvdG90eXBlLnRvQ29sb3IgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIG5ldyBDb2xvcihbdGhpcy52YWx1ZSwgdGhpcy52YWx1ZSwgdGhpcy52YWx1ZV0pO1xufTtcbkRpbWVuc2lvbi5wcm90b3R5cGUuZ2VuQ1NTID0gZnVuY3Rpb24gKGNvbnRleHQsIG91dHB1dCkge1xuICAgIGlmICgoY29udGV4dCAmJiBjb250ZXh0LnN0cmljdFVuaXRzKSAmJiAhdGhpcy51bml0LmlzU2luZ3VsYXIoKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJNdWx0aXBsZSB1bml0cyBpbiBkaW1lbnNpb24uIENvcnJlY3QgdGhlIHVuaXRzIG9yIHVzZSB0aGUgdW5pdCBmdW5jdGlvbi4gQmFkIHVuaXQ6IFwiICsgdGhpcy51bml0LnRvU3RyaW5nKCkpO1xuICAgIH1cblxuICAgIHZhciB2YWx1ZSA9IHRoaXMuZnJvdW5kKGNvbnRleHQsIHRoaXMudmFsdWUpLFxuICAgICAgICBzdHJWYWx1ZSA9IFN0cmluZyh2YWx1ZSk7XG5cbiAgICBpZiAodmFsdWUgIT09IDAgJiYgdmFsdWUgPCAwLjAwMDAwMSAmJiB2YWx1ZSA+IC0wLjAwMDAwMSkge1xuICAgICAgICAvLyB3b3VsZCBiZSBvdXRwdXQgMWUtNiBldGMuXG4gICAgICAgIHN0clZhbHVlID0gdmFsdWUudG9GaXhlZCgyMCkucmVwbGFjZSgvMCskLywgXCJcIik7XG4gICAgfVxuXG4gICAgaWYgKGNvbnRleHQgJiYgY29udGV4dC5jb21wcmVzcykge1xuICAgICAgICAvLyBaZXJvIHZhbHVlcyBkb2Vzbid0IG5lZWQgYSB1bml0XG4gICAgICAgIGlmICh2YWx1ZSA9PT0gMCAmJiB0aGlzLnVuaXQuaXNMZW5ndGgoKSkge1xuICAgICAgICAgICAgb3V0cHV0LmFkZChzdHJWYWx1ZSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvLyBGbG9hdCB2YWx1ZXMgZG9lc24ndCBuZWVkIGEgbGVhZGluZyB6ZXJvXG4gICAgICAgIGlmICh2YWx1ZSA+IDAgJiYgdmFsdWUgPCAxKSB7XG4gICAgICAgICAgICBzdHJWYWx1ZSA9IChzdHJWYWx1ZSkuc3Vic3RyKDEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgb3V0cHV0LmFkZChzdHJWYWx1ZSk7XG4gICAgdGhpcy51bml0LmdlbkNTUyhjb250ZXh0LCBvdXRwdXQpO1xufTtcblxuLy8gSW4gYW4gb3BlcmF0aW9uIGJldHdlZW4gdHdvIERpbWVuc2lvbnMsXG4vLyB3ZSBkZWZhdWx0IHRvIHRoZSBmaXJzdCBEaW1lbnNpb24ncyB1bml0LFxuLy8gc28gYDFweCArIDJgIHdpbGwgeWllbGQgYDNweGAuXG5EaW1lbnNpb24ucHJvdG90eXBlLm9wZXJhdGUgPSBmdW5jdGlvbiAoY29udGV4dCwgb3AsIG90aGVyKSB7XG4gICAgLypqc2hpbnQgbm9lbXB0eTpmYWxzZSAqL1xuICAgIHZhciB2YWx1ZSA9IHRoaXMuX29wZXJhdGUoY29udGV4dCwgb3AsIHRoaXMudmFsdWUsIG90aGVyLnZhbHVlKSxcbiAgICAgICAgdW5pdCA9IHRoaXMudW5pdC5jbG9uZSgpO1xuXG4gICAgaWYgKG9wID09PSAnKycgfHwgb3AgPT09ICctJykge1xuICAgICAgICBpZiAodW5pdC5udW1lcmF0b3IubGVuZ3RoID09PSAwICYmIHVuaXQuZGVub21pbmF0b3IubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICB1bml0ID0gb3RoZXIudW5pdC5jbG9uZSgpO1xuICAgICAgICAgICAgaWYgKHRoaXMudW5pdC5iYWNrdXBVbml0KSB7XG4gICAgICAgICAgICAgICAgdW5pdC5iYWNrdXBVbml0ID0gdGhpcy51bml0LmJhY2t1cFVuaXQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAob3RoZXIudW5pdC5udW1lcmF0b3IubGVuZ3RoID09PSAwICYmIHVuaXQuZGVub21pbmF0b3IubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAvLyBkbyBub3RoaW5nXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvdGhlciA9IG90aGVyLmNvbnZlcnRUbyh0aGlzLnVuaXQudXNlZFVuaXRzKCkpO1xuXG4gICAgICAgICAgICBpZiAoY29udGV4dC5zdHJpY3RVbml0cyAmJiBvdGhlci51bml0LnRvU3RyaW5nKCkgIT09IHVuaXQudG9TdHJpbmcoKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkluY29tcGF0aWJsZSB1bml0cy4gQ2hhbmdlIHRoZSB1bml0cyBvciB1c2UgdGhlIHVuaXQgZnVuY3Rpb24uIEJhZCB1bml0czogJ1wiICsgdW5pdC50b1N0cmluZygpICtcbiAgICAgICAgICAgICAgICAgICAgXCInIGFuZCAnXCIgKyBvdGhlci51bml0LnRvU3RyaW5nKCkgKyBcIicuXCIpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YWx1ZSA9IHRoaXMuX29wZXJhdGUoY29udGV4dCwgb3AsIHRoaXMudmFsdWUsIG90aGVyLnZhbHVlKTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSBpZiAob3AgPT09ICcqJykge1xuICAgICAgICB1bml0Lm51bWVyYXRvciA9IHVuaXQubnVtZXJhdG9yLmNvbmNhdChvdGhlci51bml0Lm51bWVyYXRvcikuc29ydCgpO1xuICAgICAgICB1bml0LmRlbm9taW5hdG9yID0gdW5pdC5kZW5vbWluYXRvci5jb25jYXQob3RoZXIudW5pdC5kZW5vbWluYXRvcikuc29ydCgpO1xuICAgICAgICB1bml0LmNhbmNlbCgpO1xuICAgIH0gZWxzZSBpZiAob3AgPT09ICcvJykge1xuICAgICAgICB1bml0Lm51bWVyYXRvciA9IHVuaXQubnVtZXJhdG9yLmNvbmNhdChvdGhlci51bml0LmRlbm9taW5hdG9yKS5zb3J0KCk7XG4gICAgICAgIHVuaXQuZGVub21pbmF0b3IgPSB1bml0LmRlbm9taW5hdG9yLmNvbmNhdChvdGhlci51bml0Lm51bWVyYXRvcikuc29ydCgpO1xuICAgICAgICB1bml0LmNhbmNlbCgpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IERpbWVuc2lvbih2YWx1ZSwgdW5pdCk7XG59O1xuRGltZW5zaW9uLnByb3RvdHlwZS5jb21wYXJlID0gZnVuY3Rpb24gKG90aGVyKSB7XG4gICAgdmFyIGEsIGI7XG5cbiAgICBpZiAoIShvdGhlciBpbnN0YW5jZW9mIERpbWVuc2lvbikpIHtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy51bml0LmlzRW1wdHkoKSB8fCBvdGhlci51bml0LmlzRW1wdHkoKSkge1xuICAgICAgICBhID0gdGhpcztcbiAgICAgICAgYiA9IG90aGVyO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGEgPSB0aGlzLnVuaWZ5KCk7XG4gICAgICAgIGIgPSBvdGhlci51bmlmeSgpO1xuICAgICAgICBpZiAoYS51bml0LmNvbXBhcmUoYi51bml0KSAhPT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBOb2RlLm51bWVyaWNDb21wYXJlKGEudmFsdWUsIGIudmFsdWUpO1xufTtcbkRpbWVuc2lvbi5wcm90b3R5cGUudW5pZnkgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29udmVydFRvKHsgbGVuZ3RoOiAncHgnLCBkdXJhdGlvbjogJ3MnLCBhbmdsZTogJ3JhZCcgfSk7XG59O1xuRGltZW5zaW9uLnByb3RvdHlwZS5jb252ZXJ0VG8gPSBmdW5jdGlvbiAoY29udmVyc2lvbnMpIHtcbiAgICB2YXIgdmFsdWUgPSB0aGlzLnZhbHVlLCB1bml0ID0gdGhpcy51bml0LmNsb25lKCksXG4gICAgICAgIGksIGdyb3VwTmFtZSwgZ3JvdXAsIHRhcmdldFVuaXQsIGRlcml2ZWRDb252ZXJzaW9ucyA9IHt9LCBhcHBseVVuaXQ7XG5cbiAgICBpZiAodHlwZW9mIGNvbnZlcnNpb25zID09PSAnc3RyaW5nJykge1xuICAgICAgICBmb3IgKGkgaW4gdW5pdENvbnZlcnNpb25zKSB7XG4gICAgICAgICAgICBpZiAodW5pdENvbnZlcnNpb25zW2ldLmhhc093blByb3BlcnR5KGNvbnZlcnNpb25zKSkge1xuICAgICAgICAgICAgICAgIGRlcml2ZWRDb252ZXJzaW9ucyA9IHt9O1xuICAgICAgICAgICAgICAgIGRlcml2ZWRDb252ZXJzaW9uc1tpXSA9IGNvbnZlcnNpb25zO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnZlcnNpb25zID0gZGVyaXZlZENvbnZlcnNpb25zO1xuICAgIH1cbiAgICBhcHBseVVuaXQgPSBmdW5jdGlvbiAoYXRvbWljVW5pdCwgZGVub21pbmF0b3IpIHtcbiAgICAgICAgLyoganNoaW50IGxvb3BmdW5jOnRydWUgKi9cbiAgICAgICAgaWYgKGdyb3VwLmhhc093blByb3BlcnR5KGF0b21pY1VuaXQpKSB7XG4gICAgICAgICAgICBpZiAoZGVub21pbmF0b3IpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlIC8gKGdyb3VwW2F0b21pY1VuaXRdIC8gZ3JvdXBbdGFyZ2V0VW5pdF0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlICogKGdyb3VwW2F0b21pY1VuaXRdIC8gZ3JvdXBbdGFyZ2V0VW5pdF0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gdGFyZ2V0VW5pdDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhdG9taWNVbml0O1xuICAgIH07XG5cbiAgICBmb3IgKGdyb3VwTmFtZSBpbiBjb252ZXJzaW9ucykge1xuICAgICAgICBpZiAoY29udmVyc2lvbnMuaGFzT3duUHJvcGVydHkoZ3JvdXBOYW1lKSkge1xuICAgICAgICAgICAgdGFyZ2V0VW5pdCA9IGNvbnZlcnNpb25zW2dyb3VwTmFtZV07XG4gICAgICAgICAgICBncm91cCA9IHVuaXRDb252ZXJzaW9uc1tncm91cE5hbWVdO1xuXG4gICAgICAgICAgICB1bml0Lm1hcChhcHBseVVuaXQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdW5pdC5jYW5jZWwoKTtcblxuICAgIHJldHVybiBuZXcgRGltZW5zaW9uKHZhbHVlLCB1bml0KTtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IERpbWVuc2lvbjtcbiJdfQ==