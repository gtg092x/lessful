"use strict";

var Node = require("./node"),
    unitConversions = require("../data/unit-conversions"),
    utils = require("../utils");

var Unit = function Unit(numerator, denominator, backupUnit) {
    this.numerator = numerator ? utils.copyArray(numerator).sort() : [];
    this.denominator = denominator ? utils.copyArray(denominator).sort() : [];
    if (backupUnit) {
        this.backupUnit = backupUnit;
    } else if (numerator && numerator.length) {
        this.backupUnit = numerator[0];
    }
};

Unit.prototype = new Node();
Unit.prototype.type = "Unit";
Unit.prototype.clone = function () {
    return new Unit(utils.copyArray(this.numerator), utils.copyArray(this.denominator), this.backupUnit);
};
Unit.prototype.genCSS = function (context, output) {
    // Dimension checks the unit is singular and throws an error if in strict math mode.
    var strictUnits = context && context.strictUnits;
    if (this.numerator.length === 1) {
        output.add(this.numerator[0]); // the ideal situation
    } else if (!strictUnits && this.backupUnit) {
        output.add(this.backupUnit);
    } else if (!strictUnits && this.denominator.length) {
        output.add(this.denominator[0]);
    }
};
Unit.prototype.toString = function () {
    var i,
        returnStr = this.numerator.join("*");
    for (i = 0; i < this.denominator.length; i++) {
        returnStr += "/" + this.denominator[i];
    }
    return returnStr;
};
Unit.prototype.compare = function (other) {
    return this.is(other.toString()) ? 0 : undefined;
};
Unit.prototype.is = function (unitString) {
    return this.toString().toUpperCase() === unitString.toUpperCase();
};
Unit.prototype.isLength = function () {
    return Boolean(this.toCSS().match(/px|em|%|in|cm|mm|pc|pt|ex/));
};
Unit.prototype.isEmpty = function () {
    return this.numerator.length === 0 && this.denominator.length === 0;
};
Unit.prototype.isSingular = function () {
    return this.numerator.length <= 1 && this.denominator.length === 0;
};
Unit.prototype.map = function (callback) {
    var i;

    for (i = 0; i < this.numerator.length; i++) {
        this.numerator[i] = callback(this.numerator[i], false);
    }

    for (i = 0; i < this.denominator.length; i++) {
        this.denominator[i] = callback(this.denominator[i], true);
    }
};
Unit.prototype.usedUnits = function () {
    var group,
        result = {},
        mapUnit,
        groupName;

    mapUnit = function mapUnit(atomicUnit) {
        /*jshint loopfunc:true */
        if (group.hasOwnProperty(atomicUnit) && !result[groupName]) {
            result[groupName] = atomicUnit;
        }

        return atomicUnit;
    };

    for (groupName in unitConversions) {
        if (unitConversions.hasOwnProperty(groupName)) {
            group = unitConversions[groupName];

            this.map(mapUnit);
        }
    }

    return result;
};
Unit.prototype.cancel = function () {
    var counter = {},
        atomicUnit,
        i;

    for (i = 0; i < this.numerator.length; i++) {
        atomicUnit = this.numerator[i];
        counter[atomicUnit] = (counter[atomicUnit] || 0) + 1;
    }

    for (i = 0; i < this.denominator.length; i++) {
        atomicUnit = this.denominator[i];
        counter[atomicUnit] = (counter[atomicUnit] || 0) - 1;
    }

    this.numerator = [];
    this.denominator = [];

    for (atomicUnit in counter) {
        if (counter.hasOwnProperty(atomicUnit)) {
            var count = counter[atomicUnit];

            if (count > 0) {
                for (i = 0; i < count; i++) {
                    this.numerator.push(atomicUnit);
                }
            } else if (count < 0) {
                for (i = 0; i < -count; i++) {
                    this.denominator.push(atomicUnit);
                }
            }
        }
    }

    this.numerator.sort();
    this.denominator.sort();
};
module.exports = Unit;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90cmVlL3VuaXQuanMiXSwibmFtZXMiOlsiTm9kZSIsInJlcXVpcmUiLCJ1bml0Q29udmVyc2lvbnMiLCJ1dGlscyIsIlVuaXQiLCJudW1lcmF0b3IiLCJkZW5vbWluYXRvciIsImJhY2t1cFVuaXQiLCJjb3B5QXJyYXkiLCJzb3J0IiwibGVuZ3RoIiwicHJvdG90eXBlIiwidHlwZSIsImNsb25lIiwiZ2VuQ1NTIiwiY29udGV4dCIsIm91dHB1dCIsInN0cmljdFVuaXRzIiwiYWRkIiwidG9TdHJpbmciLCJpIiwicmV0dXJuU3RyIiwiam9pbiIsImNvbXBhcmUiLCJvdGhlciIsImlzIiwidW5kZWZpbmVkIiwidW5pdFN0cmluZyIsInRvVXBwZXJDYXNlIiwiaXNMZW5ndGgiLCJCb29sZWFuIiwidG9DU1MiLCJtYXRjaCIsImlzRW1wdHkiLCJpc1Npbmd1bGFyIiwibWFwIiwiY2FsbGJhY2siLCJ1c2VkVW5pdHMiLCJncm91cCIsInJlc3VsdCIsIm1hcFVuaXQiLCJncm91cE5hbWUiLCJhdG9taWNVbml0IiwiaGFzT3duUHJvcGVydHkiLCJjYW5jZWwiLCJjb3VudGVyIiwiY291bnQiLCJwdXNoIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJQSxPQUFPQyxRQUFRLFFBQVIsQ0FBWDtBQUFBLElBQ0lDLGtCQUFrQkQsUUFBUSwwQkFBUixDQUR0QjtBQUFBLElBRUlFLFFBQVFGLFFBQVEsVUFBUixDQUZaOztBQUlBLElBQUlHLE9BQU8sU0FBUEEsSUFBTyxDQUFVQyxTQUFWLEVBQXFCQyxXQUFyQixFQUFrQ0MsVUFBbEMsRUFBOEM7QUFDckQsU0FBS0YsU0FBTCxHQUFpQkEsWUFBWUYsTUFBTUssU0FBTixDQUFnQkgsU0FBaEIsRUFBMkJJLElBQTNCLEVBQVosR0FBZ0QsRUFBakU7QUFDQSxTQUFLSCxXQUFMLEdBQW1CQSxjQUFjSCxNQUFNSyxTQUFOLENBQWdCRixXQUFoQixFQUE2QkcsSUFBN0IsRUFBZCxH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TCxVQUF0QjtBQUNIO0FBQ0o7QUFDSjtBQUNKOztBQUVELFNBQUtyQyxTQUFMLENBQWVJLElBQWY7QUFDQSxTQUFLSCxXQUFMLENBQWlCRyxJQUFqQjtBQUNILENBbENEO0FBbUNBdUMsT0FBT0MsT0FBUCxHQUFpQjdDLElBQWpCIiwiZmlsZSI6InVuaXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgTm9kZSA9IHJlcXVpcmUoXCIuL25vZGVcIiksXG4gICAgdW5pdENvbnZlcnNpb25zID0gcmVxdWlyZShcIi4uL2RhdGEvdW5pdC1jb252ZXJzaW9uc1wiKSxcbiAgICB1dGlscyA9IHJlcXVpcmUoXCIuLi91dGlsc1wiKTtcblxudmFyIFVuaXQgPSBmdW5jdGlvbiAobnVtZXJhdG9yLCBkZW5vbWluYXRvciwgYmFja3VwVW5pdCkge1xuICAgIHRoaXMubnVtZXJhdG9yID0gbnVtZXJhdG9yID8gdXRpbHMuY29weUFycmF5KG51bWVyYXRvcikuc29ydCgpIDogW107XG4gICAgdGhpcy5kZW5vbWluYXRvciA9IGRlbm9taW5hdG9yID8gdXRpbHMuY29weUFycmF5KGRlbm9taW5hdG9yKS5zb3J0KCkgOiBbXTtcbiAgICBpZiAoYmFja3VwVW5pdCkge1xuICAgICAgICB0aGlzLmJhY2t1cFVuaXQgPSBiYWNrdXBVbml0O1xuICAgIH0gZWxzZSBpZiAobnVtZXJhdG9yICYmIG51bWVyYXRvci5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5iYWNrdXBVbml0ID0gbnVtZXJhdG9yWzBdO1xuICAgIH1cbn07XG5cblVuaXQucHJvdG90eXBlID0gbmV3IE5vZGUoKTtcblVuaXQucHJvdG90eXBlLnR5cGUgPSBcIlVuaXRcIjtcblVuaXQucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBuZXcgVW5pdCh1dGlscy5jb3B5QXJyYXkodGhpcy5udW1lcmF0b3IpLCB1dGlscy5jb3B5QXJyYXkodGhpcy5kZW5vbWluYXRvciksIHRoaXMuYmFja3VwVW5pdCk7XG59O1xuVW5pdC5wcm90b3R5cGUuZ2VuQ1NTID0gZnVuY3Rpb24gKGNvbnRleHQsIG91dHB1dCkge1xuICAgIC8vIERpbWVuc2lvbiBjaGVja3MgdGhlIHVuaXQgaXMgc2luZ3VsYXIgYW5kIHRocm93cyBhbiBlcnJvciBpZiBpbiBzdHJpY3QgbWF0aCBtb2RlLlxuICAgIHZhciBzdHJpY3RVbml0cyA9IGNvbnRleHQgJiYgY29udGV4dC5zdHJpY3RVbml0cztcbiAgICBpZiAodGhpcy5udW1lcmF0b3IubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIG91dHB1dC5hZGQodGhpcy5udW1lcmF0b3JbMF0pOyAvLyB0aGUgaWRlYWwgc2l0dWF0aW9uXG4gICAgfSBlbHNlIGlmICghc3RyaWN0VW5pdHMgJiYgdGhpcy5iYWNrdXBVbml0KSB7XG4gICAgICAgIG91dHB1dC5hZGQodGhpcy5iYWNrdXBVbml0KTtcbiAgICB9IGVsc2UgaWYgKCFzdHJpY3RVbml0cyAmJiB0aGlzLmRlbm9taW5hdG9yLmxlbmd0aCkge1xuICAgICAgICBvdXRwdXQuYWRkKHRoaXMuZGVub21pbmF0b3JbMF0pO1xuICAgIH1cbn07XG5Vbml0LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgaSwgcmV0dXJuU3RyID0gdGhpcy5udW1lcmF0b3Iuam9pbihcIipcIik7XG4gICAgZm9yIChpID0gMDsgaSA8IHRoaXMuZGVub21pbmF0b3IubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgcmV0dXJuU3RyICs9IFwiL1wiICsgdGhpcy5kZW5vbWluYXRvcltpXTtcbiAgICB9XG4gICAgcmV0dXJuIHJldHVyblN0cjtcbn07XG5Vbml0LnByb3RvdHlwZS5jb21wYXJlID0gZnVuY3Rpb24gKG90aGVyKSB7XG4gICAgcmV0dXJuIHRoaXMuaXMob3RoZXIudG9TdHJpbmcoKSkgPyAwIDogdW5kZWZpbmVkO1xufTtcblVuaXQucHJvdG90eXBlLmlzID0gZnVuY3Rpb24gKHVuaXRTdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy50b1N0cmluZygpLnRvVXBwZXJDYXNlKCkgPT09IHVuaXRTdHJpbmcudG9VcHBlckNhc2UoKTtcbn07XG5Vbml0LnByb3RvdHlwZS5pc0xlbmd0aCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gQm9vbGVhbih0aGlzLnRvQ1NTKCkubWF0Y2goL3B4fGVtfCV8aW58Y218bW18cGN8cHR8ZXgvKSk7XG59O1xuVW5pdC5wcm90b3R5cGUuaXNFbXB0eSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy5udW1lcmF0b3IubGVuZ3RoID09PSAwICYmIHRoaXMuZGVub21pbmF0b3IubGVuZ3RoID09PSAwO1xufTtcblVuaXQucHJvdG90eXBlLmlzU2luZ3VsYXIgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5udW1lcmF0b3IubGVuZ3RoIDw9IDEgJiYgdGhpcy5kZW5vbWluYXRvci5sZW5ndGggPT09IDA7XG59O1xuVW5pdC5wcm90b3R5cGUubWFwID0gZnVuY3Rpb24oY2FsbGJhY2spIHtcbiAgICB2YXIgaTtcblxuICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLm51bWVyYXRvci5sZW5ndGg7IGkrKykge1xuICAgICAgICB0aGlzLm51bWVyYXRvcltpXSA9IGNhbGxiYWNrKHRoaXMubnVtZXJhdG9yW2ldLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgZm9yIChpID0gMDsgaSA8IHRoaXMuZGVub21pbmF0b3IubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgdGhpcy5kZW5vbWluYXRvcltpXSA9IGNhbGxiYWNrKHRoaXMuZGVub21pbmF0b3JbaV0sIHRydWUpO1xuICAgIH1cbn07XG5Vbml0LnByb3RvdHlwZS51c2VkVW5pdHMgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgZ3JvdXAsIHJlc3VsdCA9IHt9LCBtYXBVbml0LCBncm91cE5hbWU7XG5cbiAgICBtYXBVbml0ID0gZnVuY3Rpb24gKGF0b21pY1VuaXQpIHtcbiAgICAgICAgLypqc2hpbnQgbG9vcGZ1bmM6dHJ1ZSAqL1xuICAgICAgICBpZiAoZ3JvdXAuaGFzT3duUHJvcGVydHkoYXRvbWljVW5pdCkgJiYgIXJlc3VsdFtncm91cE5hbWVdKSB7XG4gICAgICAgICAgICByZXN1bHRbZ3JvdXBOYW1lXSA9IGF0b21pY1VuaXQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYXRvbWljVW5pdDtcbiAgICB9O1xuXG4gICAgZm9yIChncm91cE5hbWUgaW4gdW5pdENvbnZlcnNpb25zKSB7XG4gICAgICAgIGlmICh1bml0Q29udmVyc2lvbnMuaGFzT3duUHJvcGVydHkoZ3JvdXBOYW1lKSkge1xuICAgICAgICAgICAgZ3JvdXAgPSB1bml0Q29udmVyc2lvbnNbZ3JvdXBOYW1lXTtcblxuICAgICAgICAgICAgdGhpcy5tYXAobWFwVW5pdCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xufTtcblVuaXQucHJvdG90eXBlLmNhbmNlbCA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgY291bnRlciA9IHt9LCBhdG9taWNVbml0LCBpO1xuXG4gICAgZm9yIChpID0gMDsgaSA8IHRoaXMubnVtZXJhdG9yLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGF0b21pY1VuaXQgPSB0aGlzLm51bWVyYXRvcltpXTtcbiAgICAgICAgY291bnRlclthdG9taWNVbml0XSA9IChjb3VudGVyW2F0b21pY1VuaXRdIHx8IDApICsgMTtcbiAgICB9XG5cbiAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5kZW5vbWluYXRvci5sZW5ndGg7IGkrKykge1xuICAgICAgICBhdG9taWNVbml0ID0gdGhpcy5kZW5vbWluYXRvcltpXTtcbiAgICAgICAgY291bnRlclthdG9taWNVbml0XSA9IChjb3VudGVyW2F0b21pY1VuaXRdIHx8IDApIC0gMTtcbiAgICB9XG5cbiAgICB0aGlzLm51bWVyYXRvciA9IFtdO1xuICAgIHRoaXMuZGVub21pbmF0b3IgPSBbXTtcblxuICAgIGZvciAoYXRvbWljVW5pdCBpbiBjb3VudGVyKSB7XG4gICAgICAgIGlmIChjb3VudGVyLmhhc093blByb3BlcnR5KGF0b21pY1VuaXQpKSB7XG4gICAgICAgICAgICB2YXIgY291bnQgPSBjb3VudGVyW2F0b21pY1VuaXRdO1xuXG4gICAgICAgICAgICBpZiAoY291bnQgPiAwKSB7XG4gICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvdW50OyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5udW1lcmF0b3IucHVzaChhdG9taWNVbml0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGNvdW50IDwgMCkge1xuICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCAtY291bnQ7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRlbm9taW5hdG9yLnB1c2goYXRvbWljVW5pdCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5udW1lcmF0b3Iuc29ydCgpO1xuICAgIHRoaXMuZGVub21pbmF0b3Iuc29ydCgpO1xufTtcbm1vZHVsZS5leHBvcnRzID0gVW5pdDtcbiJdfQ==